<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>위험성평가 통합 시스템</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #fef9e7 0%, #fcf3cf 100%);
            min-height: 100vh;
        }

        /* 네비게이션 탭 스타일 */
        .nav-container {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tabs {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 20px 0;
            gap: 10px;
        }

        .nav-tab {
            padding: 15px 30px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            color: #4a5568;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .nav-tab:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #e6d7c3, #d4c4a8);
            color: #2d3748;
        }

        /* 컨텐츠 영역 */
        .content-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 공통 페이지 스타일 */
        .page-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 0 20px 20px 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #e6d7c3, #d4c4a8);
            border-radius: 2px;
        }

        /* 폼 공통 스타일 */
        input, textarea, select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Noto Sans KR', sans-serif;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 버튼 스타일 */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e6d7c3, #d4c4a8);
            color: #2d3748;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        /* 알림 스타일 */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        .notification.success {
            background: #48bb78;
        }

        .notification.error {
            background: #e53e3e;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 체크박스 스타일 개선 */
        input[type="checkbox"] {
            vertical-align: middle;
            margin-top: 0;
        }
        
        /* 모달 체크박스 라벨 스타일 */
        .modal-checkbox-label {
            display: flex !important;
            align-items: center !important;
            padding: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 5px;
        }
        
        .modal-checkbox-label:hover {
            background: #f7fafc;
        }
        
        .modal-checkbox-label input[type="checkbox"] {
            margin: 0 10px 0 0;
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .modal-checkbox-label span {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.2;
        }

        /* 복사 버튼 스타일 */
        .copy-row-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: #38b2ac;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* 삭제 버튼 스타일 */
        .delete-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #c53030;
        }

        /* 법적 근거 버튼 스타일 */
        .legal-basis-display {
            position: relative;
            min-height: 80px;
            cursor: pointer;
            padding: 8px;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .legal-basis-display:hover {
            border-color: #667eea;
            background: #edf2f7;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .legal-basis-display::after {
            content: "📋";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .legal-basis-display:hover::after {
            opacity: 1;
            transform: scale(1.1);
        }

        /* 법적 근거 버튼 강조 효과 */
        .legal-basis-display:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* 법적 근거 버튼 포커스 효과 */
        .legal-basis-display:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* 법적 근거 버튼 애니메이션 */
        @keyframes legalBasisPulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        .legal-basis-display {
            animation: legalBasisPulse 2s infinite;
        }

        .legal-basis-display:hover {
            animation: none;
        }
    </style>
</head>
<body>
    <div class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="title">1. 표지</button>
            <button class="nav-tab" data-tab="process">2. 작업공정</button>
            <button class="nav-tab" data-tab="riskInfo">3. 위험정보</button>
            <button class="nav-tab" data-tab="classification">4. 유해위험요인분류</button>
            <button class="nav-tab" data-tab="assessment">5. 위험성평가표</button>
            <button class="nav-tab" data-tab="reduction">6. 위험감소대책</button>
            <button class="nav-tab" data-tab="improvement">7. 개선활동</button>
        </div>
    </div>

    <div class="content-container">
        <div id="title-tab" class="tab-content active">
            <div class="page-container">
                <div class="header">
                    <div class="year-badge" style="display: inline-block; background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748; padding: 8px 20px; border-radius: 30px; font-weight: 500; font-size: 1.1rem; margin-bottom: 10px;">
                        <span id="reportYear">2025</span>년도
                    </div>
                    <h1>위험성평가 결과서</h1>
                </div>

                <section class="approval-section" style="margin: 60px 0; padding: 40px; background: #f7fafc; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);">
                    <h2 style="font-size: 1.3rem; font-weight: 600; color: #4a5568; margin-bottom: 25px; text-align: center;">결재</h2>
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);">
                        <tr>
                            <td rowspan="2" style="background: #4a5568; color: white; font-weight: 600; writing-mode: vertical-lr; text-orientation: upright; letter-spacing: 2px; padding: 15px; text-align: center;">결<br>재</td>
                                                    <td style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748; padding: 15px; text-align: center;"><input type="text" placeholder="담당자" value="담당자" style="text-align: center;"></td>
                        <td style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748; padding: 15px; text-align: center;"><input type="text" placeholder="팀장" value="팀장" style="text-align: center;"></td>
                        <td style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748; padding: 15px; text-align: center;"><input type="text" placeholder="부서장" value="부서장" style="text-align: center;"></td>
                        <td style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748; padding: 15px; text-align: center;"><input type="text" placeholder="대표이사" value="대표이사" style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td style="padding: 15px; background: white; border: 1px solid #e2e8f0;"><input type="text" placeholder="서명" style="height: 60px; text-align: center;"></td>
                            <td style="padding: 15px; background: white; border: 1px solid #e2e8f0;"><input type="text" placeholder="서명" style="height: 60px; text-align: center;"></td>
                            <td style="padding: 15px; background: white; border: 1px solid #e2e8f0;"><input type="text" placeholder="서명" style="height: 60px; text-align: center;"></td>
                            <td style="padding: 15px; background: white; border: 1px solid #e2e8f0;"><input type="text" placeholder="서명" style="height: 60px; text-align: center;"></td>
                        </tr>
                    </table>
                </section>

                <section style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);">
                    <h2 style="font-size: 1.3rem; font-weight: 600; color: #4a5568; margin-bottom: 25px; text-align: center;">사업장 정보</h2>
                    <form>
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 500; color: #4a5568; margin-bottom: 8px;">회사명</label>
                            <input type="text" id="companyName" placeholder="회사명을 입력하세요">
                        </div>
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 500; color: #4a5568; margin-bottom: 8px;">주소</label>
                            <input type="text" id="companyAddress" placeholder="사업장 주소를 입력하세요">
                        </div>
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 500; color: #4a5568; margin-bottom: 8px;">전화번호</label>
                            <input type="text" id="companyTel" placeholder="02-1234-5678">
                        </div>
                        <div style="margin-bottom: 25px;">
                            <label style="display: block; font-weight: 500; color: #4a5568; margin-bottom: 8px;">팩스번호</label>
                            <input type="text" id="companyFax" placeholder="02-1234-5679">
                        </div>
                    </form>
                </section>

                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 40px;">
                    <button class="btn btn-primary" onclick="saveAndNext('title')">저장하고 다음 →</button>
                </div>
            </div>
        </div>

        <div id="process-tab" class="tab-content">
            <div class="page-container">
                <div class="header">
                    <h1>작업공정 분석</h1>
                </div>

                <h2 style="font-size: 1.5rem; font-weight: 600; color: #4a5568; margin: 40px 0 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="width: 5px; height: 25px; background: linear-gradient(180deg, #e6d7c3, #d4c4a8); border-radius: 3px;"></span>
                    1. 사업장 개요
                </h2>
                <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 40px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <th rowspan="3" style="background: linear-gradient(135deg, #f7fafc, #e2e8f0); padding: 20px; text-align: center; font-weight: 600; color: #4a5568; border-right: 2px solid #e2e8f0; width: 150px;">사업장<br>개요</th>
                            <td colspan="2" style="padding: 15px 20px; border: 1px solid #e2e8f0;">
                                <label style="display: block; font-size: 0.85rem; color: #718096; margin-bottom: 8px;">사업장명</label>
                                <input type="text" id="workplaceName" placeholder="회사명" readonly style="background: #e6fffa; border-color: #38b2ac;">
                            </td>
                            <td style="padding: 15px 20px; border: 1px solid #e2e8f0;">
                                <label style="display: block; font-size: 0.85rem; color: #718096; margin-bottom: 8px;">대표자</label>
                                <input type="text" id="ceoName" placeholder="대표자명">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" style="padding: 15px 20px; border: 1px solid #e2e8f0;">
                                <label style="display: block; font-size: 0.85rem; color: #718096; margin-bottom: 8px;">주요생산품</label>
                                <input type="text" id="mainProducts" placeholder="주요 생산품목">
                            </td>
                            <td style="padding: 15px 20px; border: 1px solid #e2e8f0;">
                                <label style="display: block; font-size: 0.85rem; color: #718096; margin-bottom: 8px;">근로자수</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="employeeCount" placeholder="0" style="flex: 1;">
                                    <span style="color: #4a5568; font-weight: 500;">명</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 15px 20px; border: 1px solid #e2e8f0;">
                                <label style="display: block; font-size: 0.85rem; color: #718096; margin-bottom: 8px;">평가일자</label>
                                <input type="date" id="evalDate">
                            </td>
                            <td colspan="2" style="padding: 15px 20px; border: 1px solid #e2e8f0;">
                                <label style="display: block; font-size: 0.85rem; color: #718096; margin-bottom: 8px;">평가자</label>
                                <input type="text" id="evaluatorName" placeholder="평가자명">
                            </td>
                        </tr>
                    </table>
                </div>

                <h2 style="font-size: 1.5rem; font-weight: 600; color: #4a5568; margin: 40px 0 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="width: 5px; height: 25px; background: linear-gradient(180deg, #e6d7c3, #d4c4a8); border-radius: 3px;"></span>
                    2. 공정도
                </h2>
                <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <div id="processContainer">
                        </div>
                    <button class="btn btn-secondary" onclick="addProcess()" style="margin-top: 20px;">+ 공정 추가</button>
                </div>

                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 40px;">
                    <button class="btn btn-secondary" data-prev-tab="title">← 이전</button>
                    <button class="btn btn-primary" data-save-tab="process">저장하고 다음 →</button>
                </div>
            </div>
        </div>

        <div id="riskInfo-tab" class="tab-content">
            <div class="page-container">
                <div class="header">
                    <h1>위험정보</h1>
                </div>

                <div id="processSelectTabs" style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
                    </div>

                <div style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <h2 style="font-size: 1.3rem; font-weight: 600; color: #4a5568; margin-bottom: 20px;">기본 정보</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; color: #4a5568; margin-bottom: 8px;">업종명</label>
                        <input type="text" id="industryName" placeholder="업종명을 입력하세요">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 500; color: #4a5568; margin-bottom: 8px;">현재 선택된 공정</label>
                        <input type="text" id="currentProcessName" readonly style="background: #e6fffa; border-color: #38b2ac;">
                    </div>
                </div>

                <div style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <h2 style="font-size: 1.3rem; font-weight: 600; color: #4a5568; margin-bottom: 20px;">원(재)료</h2>
                    <div id="materialsList"></div>
                    <button class="btn btn-secondary" onclick="addMaterial()" style="margin-top: 10px;">+ 원재료 추가</button>
                </div>

                <div style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <h2 style="font-size: 1.3rem; font-weight: 600; color: #4a5568; margin-bottom: 20px;">기계기구 및 설비명</h2>
                    <div id="equipmentList"></div>
                    <button class="btn btn-secondary" onclick="addEquipment()" style="margin-top: 10px;">+ 기계기구 추가</button>
                </div>

                <div style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <h2 style="font-size: 1.3rem; font-weight: 600; color: #4a5568; margin-bottom: 20px;">유해화학물질</h2>
                    <div id="chemicalsList"></div>
                    <button class="btn btn-secondary" onclick="addChemical()" style="margin-top: 10px;">+ 화학물질 추가</button>
                </div>

                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 40px;">
                    <button class="btn btn-secondary" data-prev-tab="process">← 이전</button>
                    <button class="btn btn-primary" data-save-tab="riskInfo">저장하고 다음 →</button>
                </div>
            </div>
        </div>

        <div id="classification-tab" class="tab-content">
            <div class="page-container">
                <div class="header">
                    <h1>유해위험요인분류</h1>
                </div>

                <div id="classificationProcessTabs" style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
                    </div>

                <div style="background: #f7fafc; border-radius: 15px; padding: 20px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px;">
                    <h3 style="color: #4a5568; margin: 0;">현재 공정:</h3>
                    <span id="currentClassificationProcess" style="font-size: 1.2rem; font-weight: 600; color: #667eea;"></span>
                </div>

                <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748;">
                                <th style="padding: 15px; text-align: center; width: 150px;">분류</th>
                                <th style="padding: 15px; text-align: center;">유해위험요인</th>
                                <th style="padding: 15px; text-align: center; width: 100px;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="hazardClassificationBody">
                            <tr>
                                <td rowspan="1" style="background: #f7fafc; text-align: center; font-weight: 600; color: #4a5568; border: 1px solid #e2e8f0;">기계(설비)적<br>요인</td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                    <div id="mechanical-hazards" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <span style="color: #a0aec0; font-style: italic;">선택된 항목이 없습니다</span>
                                    </div>
                                </td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                                    <button class="btn btn-secondary" onclick="showHazardSelector('mechanical')" style="padding: 5px 15px; font-size: 0.85rem;">선택</button>
                                </td>
                            </tr>

                            <tr>
                                <td style="background: #f7fafc; text-align: center; font-weight: 600; color: #4a5568; border: 1px solid #e2e8f0;">전기적 요인</td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                    <div id="electrical-hazards" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <span style="color: #a0aec0; font-style: italic;">선택된 항목이 없습니다</span>
                                    </div>
                                </td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                                    <button class="btn btn-secondary" onclick="showHazardSelector('electrical')" style="padding: 5px 15px; font-size: 0.85rem;">선택</button>
                                </td>
                            </tr>

                            <tr>
                                <td style="background: #f7fafc; text-align: center; font-weight: 600; color: #4a5568; border: 1px solid #e2e8f0;">화학(물질)적<br>요인</td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                    <div id="chemical-hazards" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <span style="color: #a0aec0; font-style: italic;">선택된 항목이 없습니다</span>
                                    </div>
                                </td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                                    <button class="btn btn-secondary" onclick="showHazardSelector('chemical')" style="padding: 5px 15px; font-size: 0.85rem;">선택</button>
                                </td>
                            </tr>

                            <tr>
                                <td style="background: #f7fafc; text-align: center; font-weight: 600; color: #4a5568; border: 1px solid #e2e8f0;">생물학적 요인</td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                    <div id="biological-hazards" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <span style="color: #a0aec0; font-style: italic;">선택된 항목이 없습니다</span>
                                    </div>
                                </td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                                    <button class="btn btn-secondary" onclick="showHazardSelector('biological')" style="padding: 5px 15px; font-size: 0.85rem;">선택</button>
                                </td>
                            </tr>

                            <tr>
                                <td style="background: #f7fafc; text-align: center; font-weight: 600; color: #4a5568; border: 1px solid #e2e8f0;">작업특성 요인</td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                    <div id="ergonomic-hazards" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <span style="color: #a0aec0; font-style: italic;">선택된 항목이 없습니다</span>
                                    </div>
                                </td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                                    <button class="btn btn-secondary" onclick="showHazardSelector('ergonomic')" style="padding: 5px 15px; font-size: 0.85rem;">선택</button>
                                </td>
                            </tr>

                            <tr>
                                <td style="background: #f7fafc; text-align: center; font-weight: 600; color: #4a5568; border: 1px solid #e2e8f0;">작업환경 요인</td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                    <div id="other-hazards" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <span style="color: #a0aec0; font-style: italic;">선택된 항목이 없습니다</span>
                                    </div>
                                </td>
                                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                                    <button class="btn btn-secondary" onclick="showHazardSelector('other')" style="padding: 5px 15px; font-size: 0.85rem;">선택</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="hazardSelectorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                        <h3 id="modalTitle" style="margin-bottom: 20px; color: #4a5568; font-size: 1.3rem;"></h3>
                        <div id="modalContent" style="margin-bottom: 20px;">
                            </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeHazardSelector()">취소</button>
                            <button class="btn btn-primary" onclick="applyHazardSelection()">적용</button>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 40px;">
                    <button class="btn btn-secondary" data-prev-tab="riskInfo">← 이전</button>
                    <button class="btn btn-primary" data-save-tab="classification">저장하고 다음 →</button>
                </div>
            </div>
        </div>

        <div id="assessment-tab" class="tab-content">
            <div class="page-container">
                <div class="header">
                    <h1>위험성평가표</h1>
                </div>

                <div id="assessmentProcessTabs" style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">
                    </div>

                <div style="background: #f7fafc; border-radius: 15px; padding: 20px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">공정명</label>
                            <input type="text" id="assessmentProcessName" readonly style="background: #e6fffa; border-color: #38b2ac;">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">평가일시</label>
                            <input type="date" id="assessmentDate">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">평가자</label>
                            <input type="text" id="assessmentEvaluator" placeholder="평가자명">
                        </div>
                    </div>
                </div>

                <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 1400px; table-layout: auto;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748;">
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 120px;">작업내용</th>
                                    <th colspan="3" style="padding: 15px; text-align: center; border-left: 1px solid rgba(255,255,255,0.2);">유해 위험요인 파악</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 180px; border-left: 1px solid rgba(255,255,255,0.2); background: linear-gradient(135deg, #667eea, #764ba2); color: white;">관련<br>근거<br>법적<br>기준<br>📋</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 180px; border-left: 1px solid rgba(255,255,255,0.2);">현재상태<br>및 조치</th>
                                    <th colspan="3" style="padding: 15px; text-align: center; border-left: 1px solid rgba(255,255,255,0.2);">현재위험성</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 200px; border-left: 1px solid rgba(255,255,255,0.2);">감소 대책</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 100px; border-left: 1px solid rgba(255,255,255,0.2);">개선후<br>위험성</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 120px; border-left: 1px solid rgba(255,255,255,0.2);">개선<br>예정일</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 120px; border-left: 1px solid rgba(255,255,255,0.2);">완료일</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 100px; border-left: 1px solid rgba(255,255,255,0.2);">담당자</th>
                                    <th rowspan="2" style="padding: 15px; text-align: center; min-width: 120px; border-left: 1px solid rgba(255,255,255,0.2);">비고</th>
                                </tr>
                                <tr style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748;">
                                    <th style="padding: 10px; text-align: center; min-width: 100px; border-left: 1px solid rgba(255,255,255,0.2);">분류</th>
                                    <th style="padding: 10px; text-align: center; min-width: 150px;">원인</th>
                                    <th style="padding: 10px; text-align: center; min-width: 200px;">유해 위험 요인</th>
                                    <th style="padding: 10px; text-align: center; min-width: 80px; border-left: 1px solid rgba(255,255,255,0.2);">가능성<br>(빈도)</th>
                                    <th style="padding: 10px; text-align: center; min-width: 80px;">중대성<br>(강도)</th>
                                    <th style="padding: 10px; text-align: center; min-width: 80px;">위험성</th>
                                </tr>
                            </thead>
                            <tbody id="assessmentTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 30px; background: #f7fafc; border-radius: 15px; padding: 20px;">
                    <h3 style="font-size: 1.2rem; font-weight: 600; color: #4a5568; margin-bottom: 15px;">위험성 등급 기준</h3>
                    
                    <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; text-align: center;">
                            <tr>
                                <td rowspan="2" colspan="2" style="padding: 15px; border: 1px solid #cbd5e0; background: #e2e8f0; font-weight: 600; font-size: 1.5rem; color: #e53e3e;">5×4</td>
                                <td colspan="4" style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc; font-weight: 600;">중대성</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">매우위험(4)</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">위험(3)</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">보통(2)</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">양호(1)</td>
                            </tr>
                            <tr>
                                <td rowspan="5" style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc; font-weight: 600; writing-mode: vertical-lr;">가능성</td>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">매우자주<br>(5)</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ff6b6b; color: white; font-weight: 600;">20</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ff6b6b; color: white; font-weight: 600;">15</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ff8787; color: white; font-weight: 600;">10</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffd43b; font-weight: 600;">5</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">자주<br>(4)</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ff6b6b; color: white; font-weight: 600;">16</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ff8787; color: white; font-weight: 600;">12</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffa94d; font-weight: 600;">8</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffd43b; font-weight: 600;">4</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">보통<br>(3)</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ff8787; color: white; font-weight: 600;">12</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffa94d; font-weight: 600;">9</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffd43b; font-weight: 600;">6</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #51cf66; font-weight: 600;">3</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">가끔<br>(2)</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffa94d; font-weight: 600;">8</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffd43b; font-weight: 600;">6</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffd43b; font-weight: 600;">4</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #51cf66; font-weight: 600;">2</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #cbd5e0; background: #f7fafc;">매우가끔<br>(1)</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #ffd43b; font-weight: 600;">4</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #51cf66; font-weight: 600;">3</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #51cf66; font-weight: 600;">2</td>
                                <td style="padding: 15px; border: 1px solid #cbd5e0; background: #51cf66; font-weight: 600;">1</td>
                            </tr>
                        </table>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #e2e8f0;">
                                <th style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">위험성 수준</th>
                                <th style="padding: 10px; border: 1px solid #cbd5e0; text-align: center;">관리기준</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 15px; border: 1px solid #e2e8f0; text-align: center; background: #51cf66; font-weight: 600;">
                                    1~5<br>낮음
                                </td>
                                <td style="padding: 15px; border: 1px solid #e2e8f0; background: #51cf66;">
                                    모니터링
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; border: 1px solid #e2e8f0; text-align: center; background: #ffd43b; font-weight: 600;">
                                    6~11<br>보통
                                </td>
                                <td style="padding: 15px; border: 1px solid #e2e8f0; background: #ffd43b;">
                                    개선
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 15px; border: 1px solid #e2e8f0; text-align: center; background: #ff8787; font-weight: 600;">
                                    12~20<br>높음
                                </td>
                                <td style="padding: 15px; border: 1px solid #e2e8f0; background: #ff8787; color: white;">
                                    즉시 개선/작업중지
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="legalBasisModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 95%; max-width: 900px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                            <h3 style="color: #4a5568; font-size: 1.4rem; margin: 0;">📋 법적 근거 선택</h3>
                            <button onclick="closeLegalBasisModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #718096;">&times;</button>
                        </div>
                        <div id="legalBasisContent" style="margin-bottom: 25px;">
                            </div>
                        <div style="display: flex; gap: 15px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                            <button class="btn btn-secondary" onclick="closeLegalBasisModal()" style="padding: 12px 25px;">취소</button>
                            <button class="btn btn-primary" onclick="applyLegalBasis()" style="padding: 12px 25px;">✅ 적용</button>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 40px;">
                    <button class="btn btn-secondary" data-prev-tab="classification">← 이전</button>
                    <button class="btn btn-secondary" data-add-assessment>+ 평가 항목 추가</button>
                    <button class="btn btn-primary" data-save-tab="assessment">저장하고 다음 →</button>
                </div>
            </div>
        </div>

        <div id="reduction-tab" class="tab-content">
            <div class="page-container">
                <div class="header">
                    <h1>위험성 감소 대책 및 실행 계획서</h1>
                </div>

                <div style="background: #f7fafc; border-radius: 15px; padding: 20px; margin-bottom: 30px;">
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">공정(작업)명</label>
                            <input type="text" id="reductionProcessName" placeholder="공정명 입력" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">실행부서</label>
                            <input type="text" id="executionDept" placeholder="실행부서명" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">작성일</label>
                            <input type="date" id="reductionDate" style="width: 100%;">
                        </div>
                    </div>
                </div>

                <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 30px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748;">
                                <th rowspan="2" style="padding: 15px; text-align: center; width: 80px; border: 1px solid rgba(255,255,255,0.2);">번호</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">재해<br>형태</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">감소대책<br>(위험성평가서 대책보다 구체적 작성)</th>
                                <th colspan="2" style="padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">실행계획</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; width: 100px; border: 1px solid rgba(255,255,255,0.2);">확인 일자<br>(완료일)</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; width: 120px; border: 1px solid rgba(255,255,255,0.2);">비고<br>(비용/진원)</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; width: 80px; border: 1px solid rgba(255,255,255,0.2);">관리</th>
                            </tr>
                            <tr style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748;">
                                <th style="padding: 10px; text-align: center; width: 100px; border: 1px solid rgba(255,255,255,0.2);">조치결과</th>
                                <th style="padding: 10px; text-align: center; width: 100px; border: 1px solid rgba(255,255,255,0.2);">일정</th>
                            </tr>
                        </thead>
                        <tbody id="reductionTableBody">
                            </tbody>
                    </table>
                </div>

                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button class="btn btn-secondary" data-prev-tab="assessment">← 이전</button>
                    <button class="btn btn-secondary" data-add-reduction>+ 대책 추가</button>
                    <button class="btn btn-primary" data-save-tab="reduction">저장하고 다음 →</button>
                </div>
            </div>
        </div>

        <div id="improvement-tab" class="tab-content">
            <div class="page-container">
                <div class="header">
                    <h1>위험성평가 개선 안전보건활동 내용</h1>
                </div>

                <div style="background: #f7fafc; border-radius: 15px; padding: 20px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">공정</label>
                            <input type="text" id="improvementProcess" placeholder="공정명 입력" style="width: 100%;">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 5px;">작성일</label>
                            <input type="date" id="improvementWriteDate" style="width: 100%;">
                        </div>
                    </div>
                </div>

                <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 30px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748;">
                                <th rowspan="2" style="padding: 15px; text-align: center; width: 50px; border: 1px solid rgba(255,255,255,0.2);">순번</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">위험성평가</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">감소대책</th>
                                <th colspan="3" style="padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">개선 후 위험성</th>
                                <th rowspan="2" style="padding: 15px; text-align: center; width: 80px; border: 1px solid rgba(255,255,255,0.2);">관리</th>
                            </tr>
                            <tr style="background: linear-gradient(135deg, #e6d7c3, #d4c4a8); color: #2d3748;">
                                <th style="padding: 10px; text-align: center; width: 80px; border: 1px solid rgba(255,255,255,0.2);">가능성<br>(빈도)</th>
                                <th style="padding: 10px; text-align: center; width: 80px; border: 1px solid rgba(255,255,255,0.2);">중대성<br>(강도)</th>
                                <th style="padding: 10px; text-align: center; width: 80px; border: 1px solid rgba(255,255,255,0.2);">위험성</th>
                            </tr>
                        </thead>
                        <tbody id="improvementTableBody">
                            </tbody>
                    </table>
                    <div style="text-align: center; padding: 15px;">
                        <button class="btn btn-secondary" onclick="addImprovementRow()">+ 항목 추가</button>
                    </div>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <div style="font-size: 3rem; color: #667eea;">➡️</div>
                </div>

                <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                    <h2 style="font-size: 1.3rem; font-weight: 600; color: #4a5568; margin-bottom: 20px;">가공작업 (B)</h2>
                    
                    <div style="margin-bottom: 30px;">
                        <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 10px;">유해위험요인</label>
                        <textarea id="improvementHazards" rows="4" placeholder="유해위험요인을 입력하세요" style="width: 100%;"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h3 style="font-size: 1.1rem; font-weight: 600; color: #4a5568; margin-bottom: 15px;">현재 안전보건 조치</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f7fafc;">
                                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">현재 위험성</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                                <div>
                                                    <label style="font-size: 0.85rem; color: #718096;">가능성(빈도)</label>
                                                    <select id="currentPossibility" style="width: 100%;">
                                                        <option value="">선택</option>
                                                        <option value="5">매우자주(5)</option>
                                                        <option value="4">자주(4)</option>
                                                        <option value="3">보통(3)</option>
                                                        <option value="2">가끔(2)</option>
                                                        <option value="1">매우가끔(1)</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="font-size: 0.85rem; color: #718096;">중대성(강도)</label>
                                                    <select id="currentSeverity" style="width: 100%;">
                                                        <option value="">선택</option>
                                                        <option value="4">매우위험(4)</option>
                                                        <option value="3">위험(3)</option>
                                                        <option value="2">보통(2)</option>
                                                        <option value="1">양호(1)</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="font-size: 0.85rem; color: #718096;">위험성</label>
                                                    <input type="text" id="currentRisk" readonly style="background: #f7fafc; text-align: center;">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div>
                            <h3 style="font-size: 1.1rem; font-weight: 600; color: #4a5568; margin-bottom: 15px;">개선 조치방안</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f7fafc;">
                                        <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">개선 후 위험성</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e2e8f0;">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                                <div>
                                                    <label style="font-size: 0.85rem; color: #718096;">가능성(빈도)</label>
                                                    <select id="improvedPossibility" style="width: 100%;">
                                                        <option value="">선택</option>
                                                        <option value="5">매우자주(5)</option>
                                                        <option value="4">자주(4)</option>
                                                        <option value="3">보통(3)</option>
                                                        <option value="2">가끔(2)</option>
                                                        <option value="1">매우가끔(1)</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="font-size: 0.85rem; color: #718096;">중대성(강도)</label>
                                                    <select id="improvedSeverity" style="width: 100%;">
                                                        <option value="">선택</option>
                                                        <option value="4">매우위험(4)</option>
                                                        <option value="3">위험(3)</option>
                                                        <option value="2">보통(2)</option>
                                                        <option value="1">양호(1)</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="font-size: 0.85rem; color: #718096;">위험성</label>
                                                    <input type="text" id="improvedRisk" readonly style="background: #f7fafc; text-align: center;">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 10px;">작업 단위 개선사항 (B-1)</label>
                        <textarea id="improvementDetails" rows="6" placeholder="개선사항을 상세히 입력하세요" style="width: 100%;"></textarea>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 40px;">
                    <button class="btn btn-secondary" data-prev-tab="reduction">← 이전</button>
                    <button class="btn btn-primary" data-save-tab="improvement">저장</button>
                    <button class="btn btn-primary" data-generate-excel style="background: linear-gradient(135deg, #48bb78, #38a169); margin-right: 10px;">📊 엑셀 리포트 생성</button>
                    <button class="btn btn-primary" data-generate-pdf style="background: linear-gradient(135deg, #e53e3e, #c53030);">📄 PDF 리포트 생성</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // 전역 데이터
        const appData = {
            currentTab: 'title',
            company: {},
            workplace: {},
            processes: [],
            currentProcessIndex: 0,
            riskInfo: {
                industryName: ''
            }
        };

        // 알림 표시 함수
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // 엑셀에서 읽어온 법규 데이터를 저장할 전역 변수
        let legalBasisData = [];
        let legalBasisMapping = {}; // 유해위험요인별 법규 매핑

        // 엑셀 데이터 처리 함수
        function processExcelData(workbook) {
            try {
                console.log('엑셀 데이터 처리 시작');
                
                // 기존 데이터 완전 초기화
                legalBasisData = [];
                legalBasisMapping = {};
                
                console.log('기존 데이터 초기화 완료');
                console.log('초기화 후 legalBasisData 길이:', legalBasisData.length);
                console.log('초기화 후 legalBasisMapping 키 수:', Object.keys(legalBasisMapping).length);
                
                // 첫 번째 시트 가져오기
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                console.log('처리할 시트:', sheetName);
                console.log('워크시트 범위:', worksheet['!ref']);
                
                // 시트를 JSON으로 변환
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                console.log('JSON 변환 완료, 행 수:', jsonData.length);
                
                if (!jsonData || jsonData.length === 0) {
                    throw new Error('엑셀 파일에 데이터가 없습니다.');
                }
            
            // 법규 데이터 추출 및 매핑 생성
            legalBasisData = [];
            legalBasisMapping = {};
            
            // 헤더 확인
            console.log('헤더:', jsonData[0]);
            console.log('전체 데이터 구조:', jsonData.slice(0, 5));
            
            // 모든 열을 확인하여 법규 데이터가 있는 열 찾기
            let legalColumnIndex = -1;
            for (let col = 0; col < jsonData[0].length; col++) {
                const headerText = jsonData[0][col] ? jsonData[0][col].toString().toLowerCase() : '';
                if (headerText.includes('법') || headerText.includes('규') || headerText.includes('조') || headerText.includes('근거')) {
                    legalColumnIndex = col;
                    console.log(`법규 데이터 열 발견: ${col}번째 열 - "${jsonData[0][col]}"`);
                    break;
                }
            }
            
            // 법규 열을 찾지 못한 경우 기본값 사용
            if (legalColumnIndex === -1) {
                legalColumnIndex = 5; // 기본값
                console.log('법규 데이터 열을 찾지 못하여 기본값(5번째 열) 사용');
            }
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length > legalColumnIndex) {
                    const majorCategory = row[0] ? row[0].toString().trim() : '';
                    const minorCategory = row[1] ? row[1].toString().trim() : '';
                    const legalText = row[legalColumnIndex] ? row[legalColumnIndex].toString().trim() : '';
                    
                    console.log(`행 ${i}: 대분류="${majorCategory}", 중분류="${minorCategory}", 법규="${legalText}"`);
                    
                    if (legalText && legalText !== '' && !legalBasisData.includes(legalText)) {
                        legalBasisData.push(legalText);
                    }
                    
                    // 유해위험요인별 법규 매핑 생성
                    if (minorCategory && legalText && legalText !== '') {
                        if (!legalBasisMapping[minorCategory]) {
                            legalBasisMapping[minorCategory] = [];
                        }
                        if (!legalBasisMapping[minorCategory].includes(legalText)) {
                            legalBasisMapping[minorCategory].push(legalText);
                        }
                    }
                }
            }
            
            // 대분류와 중분류별로 정렬
            legalBasisData.sort((a, b) => a.localeCompare(b, 'ko'));
            
            console.log(`총 ${legalBasisData.length}개의 법규 로드 완료`);
            console.log('로드된 법규 예시:', legalBasisData.slice(0, 5));
            console.log('유해위험요인 매핑:', Object.keys(legalBasisMapping).length + '개 카테고리');
            
            // 로컬 스토리지에 저장
            saveLegalBasisToStorage();
            
            // 로드 완료 알림
            if (legalBasisData.length > 0) {
                showNotification(`${legalBasisData.length}개의 법규가 로드되었습니다! (브라우저에 저장됨)`, 'success');
                console.log('최종 legalBasisData 길이:', legalBasisData.length);
                console.log('최종 legalBasisMapping 키 수:', Object.keys(legalBasisMapping).length);
                console.log('새로 로드된 법규 데이터 샘플:', legalBasisData.slice(0, 5));
            }
            
            console.log('엑셀 데이터 처리 완료');
            
        } catch (error) {
            console.error('엑셀 데이터 처리 중 오류:', error);
            console.error('오류 상세:', error.message);
            throw error; // 상위 함수로 오류 전파
        }
        }

        // 로컬 스토리지에 법규 데이터 저장
        function saveLegalBasisToStorage() {
            const dataToSave = {
                legalBasisData: legalBasisData,
                legalBasisMapping: legalBasisMapping,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            console.log('저장할 데이터:', {
                legalBasisDataLength: legalBasisData.length,
                legalBasisMappingKeys: Object.keys(legalBasisMapping).length,
                timestamp: dataToSave.timestamp
            });
            
            try {
                localStorage.setItem('riskAssessmentLegalBasis', JSON.stringify(dataToSave));
                console.log('법규 데이터가 로컬 스토리지에 저장되었습니다.');
            } catch (error) {
                console.error('로컬 스토리지 저장 실패:', error);
                // localStorage가 차단된 경우 메모리에 저장
                window.memoryLegalBasisData = dataToSave;
                console.log('법규 데이터가 메모리에 저장되었습니다.');
            }
        }

        // 로컬 스토리지에서 법규 데이터 로드
        function loadLegalBasisFromStorage() {
            try {
                const savedData = localStorage.getItem('riskAssessmentLegalBasis');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // 데이터 유효성 검사
                    if (parsedData.legalBasisData && parsedData.legalBasisMapping) {
                        legalBasisData = parsedData.legalBasisData;
                        legalBasisMapping = parsedData.legalBasisMapping;
                        
                        console.log(`저장된 법규 데이터 로드 완료: ${legalBasisData.length}개 항목`);
                        console.log('저장된 매핑 데이터:', Object.keys(legalBasisMapping).length + '개 카테고리');
                        console.log('로드된 법규 데이터 샘플:', legalBasisData.slice(0, 3));
                        
                        if (parsedData.timestamp) {
                            const savedDate = new Date(parsedData.timestamp);
                            const daysDiff = Math.floor((new Date() - savedDate) / (1000 * 60 * 60 * 24));
                            showNotification(`저장된 법규 데이터를 로드했습니다. (${daysDiff}일 전 저장)`, 'success');
                        } else {
                            showNotification(`저장된 법규 데이터를 로드했습니다. (${legalBasisData.length}개 항목)`, 'success');
                        }
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error('로컬 스토리지에서 데이터 로드 실패:', error);
                
                // localStorage가 차단된 경우 메모리에서 로드 시도
                if (window.memoryLegalBasisData) {
                    const parsedData = window.memoryLegalBasisData;
                    if (parsedData.legalBasisData && parsedData.legalBasisMapping) {
                        legalBasisData = parsedData.legalBasisData;
                        legalBasisMapping = parsedData.legalBasisMapping;
                        
                        console.log(`메모리에서 법규 데이터 로드 완료: ${legalBasisData.length}개 항목`);
                        showNotification(`메모리에서 법규 데이터를 로드했습니다. (${legalBasisData.length}개 항목)`, 'success');
                        return true;
                    }
                }
            }
            return false;
        }

        // 파일 업로드 옵션 표시
        function showFileUploadOption() {
            // 파일 업로드 버튼이 이미 있는지 확인
            if (document.getElementById('fileUploadBtn')) return;
            
            const uploadBtn = document.createElement('button');
            uploadBtn.id = 'fileUploadBtn';
            uploadBtn.innerHTML = '📁 법규 엑셀 파일 업로드';
            uploadBtn.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: 12px 20px;
                background: linear-gradient(135deg, #e6d7c3, #d4c4a8);
                color: white;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-weight: 600;
                z-index: 1001;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
            `;
            
            // 법규 관리 버튼 추가
            const manageBtn = document.createElement('button');
            manageBtn.id = 'legalManageBtn';
            manageBtn.innerHTML = '⚙️ 법규 데이터 관리';
            manageBtn.style.cssText = `
                position: fixed;
                top: 160px;
                right: 20px;
                padding: 10px 15px;
                background: linear-gradient(135deg, #38b2ac, #319795);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                font-size: 0.9rem;
                z-index: 1001;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
                transition: all 0.3s ease;
            `;
            
            // 기본 데이터 로드 버튼 추가
            const defaultBtn = document.createElement('button');
            defaultBtn.id = 'defaultLegalBtn';
            defaultBtn.innerHTML = '📋 기본 법규 데이터 로드';
            defaultBtn.style.cssText = `
                position: fixed;
                top: 220px;
                right: 20px;
                padding: 10px 15px;
                background: linear-gradient(135deg, #f6ad55, #ed8936);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                font-size: 0.9rem;
                z-index: 1001;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
                transition: all 0.3s ease;
            `;
            
            manageBtn.onmouseover = function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.25)';
            };
            
            manageBtn.onmouseout = function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.15)';
            };
            
            manageBtn.onclick = function() {
                showLegalBasisManagement();
            };
            
            defaultBtn.onmouseover = function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.25)';
            };
            
            defaultBtn.onmouseout = function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.15)';
            };
            
            defaultBtn.onclick = function() {
                console.log('기본 법규 데이터 로드 시작...');
                loadDefaultLegalBasis();
                showNotification('기본 법규 데이터가 로드되었습니다!', 'success');
                // 모든 버튼 숨기기
                uploadBtn.style.display = 'none';
                manageBtn.style.display = 'none';
                defaultBtn.style.display = 'none';
            };
            
            uploadBtn.onmouseover = function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.3)';
            };
            
            uploadBtn.onmouseout = function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
            };
            
            uploadBtn.onclick = function() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                console.log('파일 읽기 시작:', file.name, '크기:', file.size, '타입:', file.type);
                                
                                // 파일 타입 확인
                                if (!file.type.includes('spreadsheet') && !file.type.includes('excel') && 
                                    !file.name.endsWith('.xlsx') && !file.name.endsWith('.xls') && 
                                    !file.name.endsWith('.csv')) {
                                    throw new Error('지원하지 않는 파일 형식입니다. .xlsx, .xls 또는 .csv 파일을 업로드해주세요.');
                                }
                                
                                const data = new Uint8Array(e.target.result);
                                console.log('파일 데이터 로드 완료, 크기:', data.length);
                                
                                // 데이터 유효성 검사
                                if (data.length === 0) {
                                    throw new Error('파일이 비어있습니다.');
                                }
                                
                                // XLSX 라이브러리 로드 확인
                                if (typeof XLSX === 'undefined') {
                                    throw new Error('XLSX 라이브러리가 로드되지 않았습니다.');
                                }
                                
                                console.log('XLSX 라이브러리 확인됨, 읽기 시작...');
                                
                                let workbook;
                                if (file.name.endsWith('.csv')) {
                                    // CSV 파일 처리
                                    const text = new TextDecoder().decode(data);
                                    console.log('CSV 텍스트 읽기 완료, 길이:', text.length);
                                    workbook = XLSX.read(text, { type: 'string', raw: true });
                                } else {
                                    // 엑셀 파일 처리
                                    workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: false, cellHTML: false });
                                }
                                
                                console.log('워크북 읽기 완료, 시트 수:', workbook.SheetNames.length);
                                console.log('시트 이름들:', workbook.SheetNames);
                                
                                if (workbook.SheetNames.length === 0) {
                                    throw new Error('파일에 시트가 없습니다.');
                                }
                                
                                // 기존 데이터 강제 초기화
                                legalBasisData = [];
                                legalBasisMapping = {};
                                
                                // localStorage도 강제 삭제
                                try {
                                    localStorage.removeItem('riskAssessmentLegalBasis');
                                    localStorage.clear(); // 모든 localStorage 데이터 삭제
                                    console.log('기존 localStorage 데이터 삭제 완료');
                                } catch (e) {
                                    console.log('localStorage 삭제 실패:', e);
                                }
                                
                                // 메모리 데이터도 삭제
                                if (window.memoryLegalBasisData) {
                                    delete window.memoryLegalBasisData;
                                    console.log('기존 메모리 데이터 삭제 완료');
                                }
                                
                                // 페이지 새로고침 없이 데이터 완전 초기화
                                setTimeout(() => {
                                    processExcelData(workbook);
                                }, 100);
                                showNotification('법규 파일이 성공적으로 로드되었습니다! (기존 데이터가 완전히 업데이트되었습니다)', 'success');
                                // 버튼들을 다시 표시 (재업로드 가능하도록)
                                uploadBtn.style.display = 'block';
                                manageBtn.style.display = 'block';
                                defaultBtn.style.display = 'block';
                            } catch (error) {
                                console.error('엑셀 파일 파싱 오류:', error);
                                console.error('오류 상세:', error.message);
                                console.error('스택 트레이스:', error.stack);
                                showNotification(`엑셀 파일 오류: ${error.message}`, 'error');
                                
                                // 기본 데이터로 폴백
                                console.log('기본 법규 데이터로 폴백합니다...');
                                loadDefaultLegalBasis();
                                showNotification('기본 법규 데이터가 로드되었습니다.', 'info');
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }
                };
                fileInput.click();
            };
            
            document.body.appendChild(uploadBtn);
            document.body.appendChild(manageBtn);
            document.body.appendChild(defaultBtn);
            
            // 5초 후 자동으로 기본 데이터 로드 (저장된 데이터가 없는 경우)
            setTimeout(() => {
                if (legalBasisData.length === 0) {
                    loadDefaultLegalBasis();
                    // 버튼들은 계속 표시 (재업로드 가능하도록)
                    uploadBtn.style.display = 'block';
                    manageBtn.style.display = 'block';
                    defaultBtn.style.display = 'block';
                }
            }, 5000);
        }

        // 기본 법규 데이터 로드
        function loadDefaultLegalBasis() {
            console.log('기본 법규 데이터 로드 중...');
            
            // 기본 법규 데이터
            legalBasisData = [
                "산업안전보건법 제38조(안전조치)",
                "산업안전보건법 제39조(보건조치)",
                "산업안전보건기준에 관한 규칙 제87조(원동기·회전축 등의 위험 방지)",
                "산업안전보건기준에 관한 규칙 제301조(전기 기계·기구의 충전부 방호)",
                "산업안전보건기준에 관한 규칙 제92조(정비 등의 작업 시의 운전정지 등)",
                "산업안전보건기준에 관한 규칙 제303조(배선 등의 절연피복 등)",
                "산업안전보건기준에 관한 규칙 제322조(고압활선작업)",
                "산업안전보건기준에 관한 규칙 제42조(추락의 방지)",
                "산업안전보건기준에 관한 규칙 제43조(개구부 등의 방호조치)",
                "산업안전보건기준에 관한 규칙 제44조(안전난간의 구조 및 설치요건)",
                "산업안전보건기준에 관한 규칙 제45조(안전모의 착용)",
                "산업안전보건기준에 관한 규칙 제46조(안전대의 사용)",
                "산업안전보건기준에 관한 규칙 제47조(안전화의 착용)",
                "산업안전보건기준에 관한 규칙 제48조(보호장갑의 착용)",
                "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)",
                "산업안전보건기준에 관한 규칙 제50조(보호구의 관리)",
                "산업안전보건기준에 관한 규칙 제51조(보호구의 점검)",
                "산업안전보건기준에 관한 규칙 제52조(보호구의 교체)",
                "산업안전보건기준에 관한 규칙 제53조(보호구의 보관)",
                "산업안전보건기준에 관한 규칙 제54조(보호구의 사용법 교육)"
            ];
            
            // 기본 매핑 데이터 생성
            legalBasisMapping = {
                "끼임 위험 부분 (감김, 끼임)": [
                    "산업안전보건기준에 관한 규칙 제87조(원동기·회전축 등의 위험 방지)",
                    "산업안전보건기준에 관한 규칙 제92조(정비 등의 작업 시의 운전정지 등)"
                ],
                "위험한 표면 (절단, 베임, 긁힘)": [
                    "산업안전보건기준에 관한 규칙 제87조(원동기·회전축 등의 위험 방지)",
                    "산업안전보건기준에 관한 규칙 제45조(안전모의 착용)",
                    "산업안전보건기준에 관한 규칙 제47조(안전화의 착용)",
                    "산업안전보건기준에 관한 규칙 제48조(보호장갑의 착용)"
                ],
                "기계(설비)의 맞음, 뒤집힘, 무너짐, 넘어짐/깔림 위험 부분": [
                    "산업안전보건기준에 관한 규칙 제87조(원동기·회전축 등의 위험 방지)",
                    "산업안전보건기준에 관한 규칙 제92조(정비 등의 작업 시의 운전정지 등)"
                ],
                "부딪힘 위험 부분": [
                    "산업안전보건기준에 관한 규칙 제45조(안전모의 착용)",
                    "산업안전보건기준에 관한 규칙 제47조(안전화의 착용)"
                ],
                "넘어짐 (미끄러짐, 걸림, 헛디딤)": [
                    "산업안전보건기준에 관한 규칙 제42조(추락의 방지)",
                    "산업안전보건기준에 관한 규칙 제47조(안전화의 착용)"
                ],
                "떨어짐 위험 부분 (개구부 등)": [
                    "산업안전보건기준에 관한 규칙 제42조(추락의 방지)",
                    "산업안전보건기준에 관한 규칙 제43조(개구부 등의 방호조치)",
                    "산업안전보건기준에 관한 규칙 제44조(안전난간의 구조 및 설치요건)",
                    "산업안전보건기준에 관한 규칙 제46조(안전대의 사용)"
                ],
                "감전 (안전전압 초과)": [
                    "산업안전보건기준에 관한 규칙 제301조(전기 기계·기구의 충전부 방호)",
                    "산업안전보건기준에 관한 규칙 제303조(배선 등의 절연피복 등)",
                    "산업안전보건기준에 관한 규칙 제322조(고압활선작업)"
                ],
                "아크": [
                    "산업안전보건기준에 관한 규칙 제301조(전기 기계·기구의 충전부 방호)",
                    "산업안전보건기준에 관한 규칙 제322조(고압활선작업)"
                ],
                "정전기": [
                    "산업안전보건기준에 관한 규칙 제301조(전기 기계·기구의 충전부 방호)"
                ],
                "화재 / 폭발 위험": [
                    "산업안전보건법 제38조(안전조치)",
                    "산업안전보건법 제39조(보건조치)"
                ],
                "가스": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "증기": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "에어로졸▪흄": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "액체▪미스트": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "고체 (분진)": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "반응성 물질": [
                    "산업안전보건법 제38조(안전조치)",
                    "산업안전보건법 제39조(보건조치)"
                ],
                "방사선": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "화재▪폭발 위험": [
                    "산업안전보건법 제38조(안전조치)",
                    "산업안전보건법 제39조(보건조치)"
                ],
                "복사열▪폭발과압": [
                    "산업안전보건법 제38조(안전조치)",
                    "산업안전보건법 제39조(보건조치)"
                ],
                "소음": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "초음파▪초저주파음": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "진동": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "근로자 실수(휴먼 에러)": [
                    "산업안전보건법 제38조(안전조치)",
                    "산업안전보건기준에 관한 규칙 제92조(정비 등의 작업 시의 운전정지 등)"
                ],
                "저압 또는 고압 상태": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "절삭 위험▪신호 결함": [
                    "산업안전보건기준에 관한 규칙 제87조(원동기·회전축 등의 위험 방지)",
                    "산업안전보건기준에 관한 규칙 제92조(정비 등의 작업 시의 운전정지 등)"
                ],
                "중량물 취급 작업": [
                    "산업안전보건기준에 관한 규칙 제42조(추락의 방지)",
                    "산업안전보건기준에 관한 규칙 제46조(안전대의 사용)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "반복 작업": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "불안정한 작업 자세": [
                    "산업안전보건기준에 관한 규칙 제42조(추락의 방지)",
                    "산업안전보건기준에 관한 규칙 제46조(안전대의 사용)"
                ],
                "작업(조작) 도구": [
                    "산업안전보건기준에 관한 규칙 제48조(보호장갑의 착용)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "기후 / 고온 / 한랭": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "기후▪고온▪한랭": [
                    "산업안전보건법 제39조(보건조치)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ],
                "조명": [
                    "산업안전보건법 제39조(보건조치)"
                ],
                "공간 및 이동통로": [
                    "산업안전보건기준에 관한 규칙 제42조(추락의 방지)",
                    "산업안전보건기준에 관한 규칙 제43조(개구부 등의 방호조치)"
                ],
                "주변 근로자": [
                    "산업안전보건기준에 관한 규칙 제92조(정비 등의 작업 시의 운전정지 등)"
                ],
                "작업 시간": [
                    "산업안전보건법 제39조(보건조치)"
                ],
                "조직 안전문화": [
                    "산업안전보건법 제38조(안전조치)",
                    "산업안전보건법 제39조(보건조치)"
                ],
                "화상": [
                    "산업안전보건기준에 관한 규칙 제48조(보호장갑의 착용)",
                    "산업안전보건기준에 관한 규칙 제49조(보호구의 착용)"
                ]
            };
            
            // 기본 데이터도 저장
            saveLegalBasisToStorage();
            
            showNotification('기본 법규 데이터가 로드되었습니다. (20개 항목)', 'success');
        }

        // 법규 데이터 관리 함수들
        function clearSavedLegalBasis() {
            try {
                localStorage.removeItem('riskAssessmentLegalBasis');
                showNotification('저장된 법규 데이터가 삭제되었습니다.', 'success');
                // 기본 데이터로 다시 로드
                loadDefaultLegalBasis();
            } catch (error) {
                console.error('저장된 데이터 삭제 실패:', error);
                showNotification('데이터 삭제 중 오류가 발생했습니다.', 'error');
            }
        }

        function showLegalBasisManagement() {
            const savedData = localStorage.getItem('riskAssessmentLegalBasis');
            let savedInfo = '저장된 데이터 없음';
            
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.timestamp) {
                        const savedDate = new Date(parsedData.timestamp);
                        const daysDiff = Math.floor((new Date() - savedDate) / (1000 * 60 * 60 * 24));
                        savedInfo = `${parsedData.legalBasisData ? parsedData.legalBasisData.length : 0}개 법규 (${daysDiff}일 전 저장)`;
                    }
                } catch (e) {
                    savedInfo = '저장된 데이터 있음 (형식 오류)';
                }
            }
            
            const message = `현재 법규 데이터 상태:\n\n` +
                          `📊 로드된 법규: ${legalBasisData.length}개\n` +
                          `📋 매핑 카테고리: ${Object.keys(legalBasisMapping).length}개\n` +
                          `💾 저장된 데이터: ${savedInfo}\n\n` +
                          `저장된 데이터를 삭제하고 기본 데이터로 초기화하시겠습니까?`;
            
            if (confirm(message)) {
                clearSavedLegalBasis();
            }
        }

        // 페이지 로드 시 엑셀 파일 읽기
        async function loadLegalBasisFromExcel() {
            try {
                console.log('법규 데이터 로드 시작...');
                
                // 방법 1: 저장된 데이터가 있는지 먼저 확인
                if (loadLegalBasisFromStorage()) {
                    console.log('저장된 법규 데이터를 사용합니다.');
                    return;
                }
                
                // 방법 2: 기본 파일 시스템 접근 시도 (Electron 등에서만 작동)
                try {
                    if (window.fs && typeof window.fs.readFile === 'function') {
                        const response = await window.fs.readFile('DBRA분류산업안전보건법.xlsx');
                        const workbook = XLSX.read(response, { type: 'array' });
                        processExcelData(workbook);
                        return;
                    }
                } catch (fileError) {
                    console.log('파일 시스템 접근 실패');
                }
                
                // 방법 3: 파일 업로드 옵션 표시
                showFileUploadOption();
                
            } catch (error) {
                console.error('법규 데이터 로드 오류:', error);
                loadDefaultLegalBasis();
            }
        }

        // 탭 전환 함수
        function showTab(tabName) {
            // 모든 탭 내용 숨기기
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 선택된 탭과 내용 보이기
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`.nav-tab[data-tab="${tabName}"]`).classList.add('active');

            appData.currentTab = tabName;
            
            // 탭별 초기화 함수 호출
            switch(tabName) {
                case 'process':
                    loadProcessData();
                    break;
                case 'riskInfo':
                    loadRiskInfoData();
                    break;
                case 'classification':
                    loadClassificationData();
                    break;
                case 'assessment':
                    loadAssessmentData();
                    break;
                case 'reduction':
                    loadReductionData();
                    break;
                case 'improvement':
                    loadImprovementData();
                    break;
            }
        }

        // 위험성 계산 함수들
        function calculateCurrentRisk() {
            const currentPossibility = document.getElementById('currentPossibility');
            const currentSeverity = document.getElementById('currentSeverity');
            const currentRisk = document.getElementById('currentRisk');
            
            const p = currentPossibility.value;
            const s = currentSeverity.value;
            if (p && s) {
                const risk = parseInt(p) * parseInt(s);
                currentRisk.value = risk;
                applyRiskColorToInput(currentRisk, risk);
            }
        }
        
        function calculateImprovedRisk() {
            const improvedPossibility = document.getElementById('improvedPossibility');
            const improvedSeverity = document.getElementById('improvedSeverity');
            const improvedRisk = document.getElementById('improvedRisk');
            
            const p = improvedPossibility.value;
            const s = improvedSeverity.value;
            if (p && s) {
                const risk = parseInt(p) * parseInt(s);
                improvedRisk.value = risk;
                applyRiskColorToInput(improvedRisk, risk);
            }
        }
        
        function applyRiskColorToInput(input, risk) {
            if (risk >= 12) {
                input.style.background = '#ff8787';
                input.style.color = 'white';
            } else if (risk >= 6) {
                input.style.background = '#ffd43b';
                input.style.color = '#000';
            } else {
                input.style.background = '#51cf66';
                input.style.color = '#000';
            }
            input.style.fontWeight = '600';
        }

        // 작업공정 데이터 로드
        function loadProcessData() {
            // 회사명 자동 입력
            const workplaceNameInput = document.getElementById('workplaceName');
            if (workplaceNameInput && appData.company.name) {
                workplaceNameInput.value = appData.company.name;
            }
            
            // 오늘 날짜 설정
            const evalDateInput = document.getElementById('evalDate');
            if (evalDateInput && !evalDateInput.value) {
                evalDateInput.valueAsDate = new Date();
            }
            
            // 저장된 공정 로드 또는 기본 공정 추가
            if (appData.processes.length === 0) {
                // 기본 공정 3개 추가
                for (let i = 0; i < 3; i++) {
                    addProcess();
                }
            } else {
                displayProcesses();
            }
        }

        // 공정 추가
        function addProcess() {
            const index = appData.processes.length;
            appData.processes.push({
                name: '',
                description: '',
                equipment: [],
                chemicals: [],
                riskInfo: {
                    materials: [],
                    equipment: [],
                    chemicals: []
                },
                hazardClassification: {},
                assessments: []
            });
            
            const container = document.getElementById('processContainer');
            const processDiv = document.createElement('div');
            processDiv.style.cssText = 'margin-bottom: 30px; padding: 20px; background: #f7fafc; border-radius: 10px;';
            processDiv.innerHTML = `
                <h3 style="color: #4a5568; margin-bottom: 15px;">공정 ${index + 1}</h3>
                <div style="display: grid; gap: 15px;">
                    <div>
                        <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">공정명</label>
                        <input type="text" id="processName${index}" placeholder="공정명 입력" onchange="updateProcessData(${index}, 'name', this.value)">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">공정설명</label>
                        <textarea id="processDesc${index}" rows="3" placeholder="공정 설명 입력" onchange="updateProcessData(${index}, 'description', this.value)"></textarea>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">주요기계기구 (쉼표로 구분)</label>
                        <input type="text" id="processEquip${index}" placeholder="예: 지게차, 컨베이어" onchange="updateProcessData(${index}, 'equipment', this.value)">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">유해위험물질 (쉼표로 구분)</label>
                        <input type="text" id="processChem${index}" placeholder="예: 윤활유, 세척제" onchange="updateProcessData(${index}, 'chemicals', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(processDiv);
        }

        // 공정 데이터 업데이트
        function updateProcessData(index, field, value) {
            if (field === 'equipment' || field === 'chemicals') {
                appData.processes[index][field] = value.split(',').map(item => item.trim()).filter(item => item);
            } else {
                appData.processes[index][field] = value;
            }
            console.log('공정 데이터 업데이트:', appData.processes[index]);
        }

        // 저장된 공정 표시
        function displayProcesses() {
            const container = document.getElementById('processContainer');
            container.innerHTML = '';
            appData.processes.forEach((process, index) => {
                const processDiv = document.createElement('div');
                processDiv.style.cssText = 'margin-bottom: 30px; padding: 20px; background: #f7fafc; border-radius: 10px;';
                processDiv.innerHTML = `
                    <h3 style="color: #4a5568; margin-bottom: 15px;">공정 ${index + 1}</h3>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">공정명</label>
                            <input type="text" id="processName${index}" value="${process.name}" placeholder="공정명 입력" onchange="updateProcessData(${index}, 'name', this.value)">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">공정설명</label>
                            <textarea id="processDesc${index}" rows="3" placeholder="공정 설명 입력" onchange="updateProcessData(${index}, 'description', this.value)">${process.description}</textarea>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">주요기계기구 (쉼표로 구분)</label>
                            <input type="text" id="processEquip${index}" value="${process.equipment.join(', ')}" placeholder="예: 지게차, 컨베이어" onchange="updateProcessData(${index}, 'equipment', this.value)">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.9rem; color: #718096; margin-bottom: 5px;">유해위험물질 (쉼표로 구분)</label>
                            <input type="text" id="processChem${index}" value="${process.chemicals.join(', ')}" placeholder="예: 윤활유, 세척제" onchange="updateProcessData(${index}, 'chemicals', this.value)">
                        </div>
                    </div>
                `;
                container.appendChild(processDiv);
            });
        }

        // 저장 및 다음 함수
        function saveAndNext(currentTab) {
            console.log('저장 및 다음:', currentTab);
            
            try {
                if (currentTab === 'title') {
                    // 표지 데이터 저장
                    appData.company.name = document.getElementById('companyName').value;
                    appData.company.address = document.getElementById('companyAddress').value;
                    appData.company.tel = document.getElementById('companyTel').value;
                    appData.company.fax = document.getElementById('companyFax').value;
                    
                    console.log('저장된 데이터:', appData.company);
                    
                    showNotification('저장되었습니다!', 'success');
                    showTab('process');
                    
                } else if (currentTab === 'process') {
                    // 작업공정 데이터 저장
                    appData.workplace.ceo = document.getElementById('ceoName').value;
                    appData.workplace.products = document.getElementById('mainProducts').value;
                    appData.workplace.employees = document.getElementById('employeeCount').value;
                    appData.workplace.evalDate = document.getElementById('evalDate').value;
                    appData.workplace.evaluator = document.getElementById('evaluatorName').value;
                    
                    console.log('저장된 작업공정 데이터:', appData.workplace);
                    console.log('저장된 공정 목록:', appData.processes);
                    
                    showNotification('저장되었습니다!', 'success');
                    showTab('riskInfo');
                    
                } else if (currentTab === 'riskInfo') {
                    // 위험정보 데이터 저장
                    if (!appData.riskInfo) {
                        appData.riskInfo = {};
                    }
                    
                    // 업종명 저장
                    const industryNameInput = document.getElementById('industryName');
                    if (industryNameInput) {
                        appData.riskInfo.industryName = industryNameInput.value;
                    }
                    
                    // 현재 공정의 위험정보 저장
                    const currentProcess = appData.processes[appData.currentProcessIndex];
                    if (!currentProcess.riskInfo) {
                        currentProcess.riskInfo = {};
                    }
                    
                    // 원재료 저장
                    const materials = [];
                    document.querySelectorAll('#materialsList input').forEach(input => {
                        if (input.value.trim()) materials.push(input.value);
                    });
                    currentProcess.riskInfo.materials = materials;
                    
                    // 기계기구 저장
                    const equipment = [];
                    document.querySelectorAll('#equipmentList input').forEach(input => {
                        if (input.value.trim()) equipment.push(input.value);
                    });
                    currentProcess.riskInfo.equipment = equipment;
                    
                    // 화학물질 저장
                    const chemicals = [];
                    document.querySelectorAll('#chemicalsList input').forEach(input => {
                        if (input.value.trim()) chemicals.push(input.value);
                    });
                    currentProcess.riskInfo.chemicals = chemicals;
                    
                    console.log('저장된 위험정보:', currentProcess.riskInfo);
                    
                    showNotification('저장되었습니다!', 'success');
                    showTab('classification');
                    
                } else if (currentTab === 'classification') {
                    // 유해위험요인분류는 실시간으로 저장되므로 별도 저장 불필요
                    console.log('저장된 유해위험요인분류:', appData.processes[appData.currentProcessIndex].hazardClassification);
                    
                    showNotification('저장되었습니다!', 'success');
                    showTab('assessment');
                    
                } else if (currentTab === 'assessment') {
                    // 위험성평가표 데이터 저장
                    const tbody = document.getElementById('assessmentTableBody');
                    const rows = tbody.querySelectorAll('tr');
                    const assessments = [];
                    
                    rows.forEach(row => {
                        try {
                            const assessment = {
                                workContent: row.cells[0].querySelector('textarea')?.value || row.cells[0].querySelector('input')?.value || '',
                                classification: row.cells[1].querySelector('input')?.value || '',
                                cause: row.cells[2].querySelector('textarea')?.value || row.cells[2].querySelector('input')?.value || '',
                                hazard: row.cells[3].querySelector('textarea')?.value || row.cells[3].querySelector('input')?.value || '',
                                legalBasis: JSON.parse(row.querySelector('.legal-basis-data')?.value || '[]'),
                                currentState: row.cells[5].querySelector('textarea')?.value || '',
                                possibility: row.cells[6].querySelector('select')?.value || '',
                                severity: row.cells[7].querySelector('select')?.value || '',
                                risk: row.cells[8].textContent === '-' ? '' : row.cells[8].textContent,
                                measures: row.cells[9].querySelector('textarea')?.value || '',
                                improvedRisk: row.cells[10].querySelector('select')?.value || '',
                                improvementDate: row.cells[11].querySelector('input')?.value || '',
                                completionDate: row.cells[12].querySelector('input')?.value || '',
                                manager: row.cells[13].querySelector('input')?.value || '',
                                note: row.cells[14].querySelector('textarea')?.value || row.cells[14].querySelector('input')?.value || ''
                            };
                            
                            assessments.push(assessment);
                        } catch (rowError) {
                            console.error('행 데이터 처리 중 오류:', rowError, row);
                            // 빈 데이터로 추가
                            assessments.push({
                                workContent: '',
                                classification: '',
                                cause: '',
                                hazard: '',
                                legalBasis: [],
                                currentState: '',
                                possibility: '',
                                severity: '',
                                risk: '',
                                measures: '',
                                improvedRisk: '',
                                improvementDate: '',
                                completionDate: '',
                                manager: '',
                                note: ''
                            });
                        }
                    });
                    
                    // 현재 공정에 평가 데이터 저장
                    appData.processes[appData.currentProcessIndex].assessments = assessments;
                    
                    console.log('저장된 위험성평가:', assessments);
                    
                    showNotification('저장되었습니다!', 'success');
                    showTab('reduction');
                    
                } else if (currentTab === 'reduction') {
                    // 위험감소대책 데이터 저장
                    showNotification('저장되었습니다!', 'success');
                    showTab('improvement');
                    
                } else if (currentTab === 'improvement') {
                    // 개선활동 데이터 저장
                    showNotification('저장되었습니다!', 'success');
                    alert('모든 평가가 완료되었습니다!');
                }
            } catch (error) {
                console.error('저장 중 오류:', error);
                showNotification('오류가 발생했습니다.', 'error');
            }
        }

        // ===== 위험정보 관련 함수 =====
        function loadRiskInfoData() {
            // 업종명 로드
            const industryNameInput = document.getElementById('industryName');
            if (industryNameInput && appData.riskInfo.industryName) {
                industryNameInput.value = appData.riskInfo.industryName;
            }
            
            // 공정 탭 생성
            const tabContainer = document.getElementById('processSelectTabs');
            tabContainer.innerHTML = '';
            
            appData.processes.forEach((process, index) => {
                const tab = document.createElement('button');
                tab.style.cssText = 'padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s ease; font-weight: 500; color: #4a5568;';
                tab.textContent = process.name || `공정 ${index + 1}`;
                tab.onclick = () => selectProcess(index);
                
                if (index === appData.currentProcessIndex) {
                    tab.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    tab.style.color = 'white';
                    tab.style.borderColor = 'transparent';
                }
                
                tabContainer.appendChild(tab);
            });
            
            // 현재 공정 정보 표시
            selectProcess(appData.currentProcessIndex);
        }

        function selectProcess(index) {
            appData.currentProcessIndex = index;
            const process = appData.processes[index];
            
            // 탭 스타일 업데이트
            const tabs = document.querySelectorAll('#processSelectTabs button');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.style.background = 'linear-gradient(135deg, #e6d7c3, #d4c4a8)';
                    tab.style.color = '#2d3748';
                    tab.style.borderColor = 'transparent';
                } else {
                    tab.style.background = 'white';
                    tab.style.color = '#4a5568';
                    tab.style.borderColor = '#e2e8f0';
                }
            });
            
            // 공정명 표시
            document.getElementById('currentProcessName').value = process.name || `공정 ${index + 1}`;
            
            // 원재료 로드
            const materialsList = document.getElementById('materialsList');
            materialsList.innerHTML = '';
            if (process.riskInfo && process.riskInfo.materials && process.riskInfo.materials.length > 0) {
                process.riskInfo.materials.forEach(item => {
                    addMaterialItem(item);
                });
            }
            
            // 기계기구 로드
            const equipmentList = document.getElementById('equipmentList');
            equipmentList.innerHTML = '';
            if (process.riskInfo && process.riskInfo.equipment && process.riskInfo.equipment.length > 0) {
                process.riskInfo.equipment.forEach(item => {
                    addEquipmentItem(item);
                });
            } else if (process.equipment && process.equipment.length > 0) {
                // 작업공정에서 입력한 기계기구 자동 로드
                process.equipment.forEach(item => {
                    addEquipmentItem(item);
                });
            }
            
            // 화학물질 로드
            const chemicalsList = document.getElementById('chemicalsList');
            chemicalsList.innerHTML = '';
            if (process.riskInfo && process.riskInfo.chemicals && process.riskInfo.chemicals.length > 0) {
                process.riskInfo.chemicals.forEach(item => {
                    addChemicalItem(item);
                });
            } else if (process.chemicals && process.chemicals.length > 0) {
                // 작업공정에서 입력한 화학물질 자동 로드
                process.chemicals.forEach(item => {
                    addChemicalItem(item);
                });
            }
        }

        function addMaterial() {
            addMaterialItem('');
        }

        function addMaterialItem(value) {
            const list = document.getElementById('materialsList');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="원재료명 입력" style="flex: 1;">
                <button class="btn btn-secondary" onclick="this.parentElement.remove()" style="padding: 8px 15px; background: #e53e3e; color: white;">삭제</button>
            `;
            list.appendChild(div);
        }

        function addEquipment() {
            addEquipmentItem('');
        }

        function addEquipmentItem(value) {
            const list = document.getElementById('equipmentList');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="기계기구명 입력" style="flex: 1;">
                <button class="btn btn-secondary" onclick="this.parentElement.remove()" style="padding: 8px 15px; background: #e53e3e; color: white;">삭제</button>
            `;
            list.appendChild(div);
        }

        function addChemical() {
            addChemicalItem('');
        }

        function addChemicalItem(value) {
            const list = document.getElementById('chemicalsList');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="화학물질명 입력" style="flex: 1;">
                <button class="btn btn-secondary" onclick="this.parentElement.remove()" style="padding: 8px 15px; background: #e53e3e; color: white;">삭제</button>
            `;
            list.appendChild(div);
        }

        // ===== 유해위험요인분류 관련 함수 =====
        const hazardLists = {
            mechanical: [
                '끼임 위험 부분 (감김, 끼임)',
                '위험한 표면 (절단, 베임, 긁힘)',
                '기계(설비)의 맞음, 뒤집힘, 무너짐, 넘어짐/깔림 위험 부분',
                '부딪힘 위험 부분',
                '넘어짐 (미끄러짐, 걸림, 헛디딤)',
                '떨어짐 위험 부분 (개구부 등)'
            ],
            electrical: [
                '감전 (안전전압 초과)',
                '아크',
                '정전기',
                '화재 / 폭발 위험'
            ],
            chemical: [
                '가스',
                '증기',
                '에어로졸▪흄',
                '액체▪미스트',
                '고체 (분진)',
                '반응성 물질',
                '방사선',
                '화재▪폭발 위험',
                '복사열▪폭발과압'
            ],
            biological: [
                '병원성 미생물, 바이러스에 의한 감염',
                '유전자 변형물질 (GMO)',
                '알러지 및 미생물',
                '동물',
                '식물'
            ],
            ergonomic: [
                '소음',
                '초음파▪초저주파음',
                '진동',
                '근로자 실수(휴먼 에러)',
                '저압 또는 고압 상태',
                '절삭 위험▪신호 결함',
                '중량물 취급 작업',
                '반복 작업',
                '불안정한 작업 자세',
                '작업(조작) 도구',
                '기후 / 고온 / 한랭'
            ],
            other: [
                '기후▪고온▪한랭',
                '조명',
                '공간 및 이동통로',
                '주변 근로자',
                '작업 시간',
                '조직 안전문화',
                '화상'
            ]
        };

        let currentHazardCategory = '';
        
        function loadClassificationData() {
            // 공정 탭 생성
            const tabContainer = document.getElementById('classificationProcessTabs');
            tabContainer.innerHTML = '';
            
            appData.processes.forEach((process, index) => {
                const tab = document.createElement('button');
                tab.style.cssText = 'padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s ease; font-weight: 500; color: #4a5568;';
                tab.textContent = process.name || `공정 ${index + 1}`;
                tab.onclick = () => selectClassificationProcess(index);
                
                if (index === appData.currentProcessIndex) {
                    tab.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    tab.style.color = 'white';
                    tab.style.borderColor = 'transparent';
                }
                
                tabContainer.appendChild(tab);
            });
            
            // 현재 공정 선택
            selectClassificationProcess(appData.currentProcessIndex);
        }

        function selectClassificationProcess(index) {
            appData.currentProcessIndex = index;
            const process = appData.processes[index];
            
            // 탭 스타일 업데이트
            const tabs = document.querySelectorAll('#classificationProcessTabs button');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.style.background = 'linear-gradient(135deg, #e6d7c3, #d4c4a8)';
                    tab.style.color = '#2d3748';
                    tab.style.borderColor = 'transparent';
                } else {
                    tab.style.background = 'white';
                    tab.style.color = '#4a5568';
                    tab.style.borderColor = '#e2e8f0';
                }
            });
            
            // 공정명 표시
            const processNameDisplay = document.getElementById('currentClassificationProcess');
            if (processNameDisplay) {
                processNameDisplay.textContent = process.name || `공정 ${index + 1}`;
            }
            
            // 저장된 분류 데이터가 있으면 로드
            if (process.hazardClassification) {
                loadSavedClassification(process.hazardClassification);
            } else {
                // 모든 카테고리 초기화
                Object.keys(hazardLists).forEach(category => {
                    updateHazardDisplay(category, []);
                });
            }
        }

        function loadSavedClassification(data) {
            // 각 카테고리별로 저장된 위험요인 표시
            Object.keys(hazardLists).forEach(category => {
                if (data[category]) {
                    updateHazardDisplay(category, data[category]);
                } else {
                    updateHazardDisplay(category, []);
                }
            });
        }

        function updateHazardDisplay(category, selectedHazards) {
            const container = document.getElementById(`${category}-hazards`);
            container.innerHTML = '';
            
            if (selectedHazards.length === 0) {
                container.innerHTML = '<span style="color: #a0aec0; font-style: italic;">선택된 항목이 없습니다</span>';
            } else {
                selectedHazards.forEach(hazard => {
                    const badge = document.createElement('span');
                    badge.style.cssText = 'display: inline-block; padding: 5px 12px; background: #e6fffa; border: 1px solid #38b2ac; border-radius: 15px; font-size: 0.9rem; color: #234e52;';
                    badge.textContent = hazard;
                    container.appendChild(badge);
                });
            }
        }

        function showHazardSelector(category) {
            currentHazardCategory = category;
            const modal = document.getElementById('hazardSelectorModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            // 카테고리명 설정
            const categoryNames = {
                'mechanical': '기계(설비)적 요인',
                'electrical': '전기적 요인',
                'chemical': '화학(물질)적 요인',
                'biological': '생물학적 요인',
                'ergonomic': '작업특성 요인',
                'other': '작업환경 요인'
            };
            
            title.textContent = categoryNames[category] + ' 선택';
            
            // 현재 선택된 항목 가져오기
            const process = appData.processes[appData.currentProcessIndex];
            const selectedHazards = (process.hazardClassification && process.hazardClassification[category]) || [];
            
            // 체크박스 목록 생성
            content.innerHTML = '';
            const checkboxContainer = document.createElement('div');
            checkboxContainer.style.cssText = 'max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; background: #fafafa;';
            
            hazardLists[category].forEach(hazard => {
                const label = document.createElement('label');
                label.className = 'modal-checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = hazard;
                checkbox.checked = selectedHazards.includes(hazard);
                
                const text = document.createElement('span');
                text.textContent = hazard;
                
                label.appendChild(checkbox);
                label.appendChild(text);
                checkboxContainer.appendChild(label);
            });
            
            content.appendChild(checkboxContainer);
            
            // 기타 입력 추가
            const otherDiv = document.createElement('div');
            otherDiv.style.cssText = 'margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;';
            otherDiv.innerHTML = `
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">기타 (직접 입력)</label>
                <input type="text" id="otherHazardInput" placeholder="기타 위험요인 입력" style="width: 100%; margin-bottom: 10px;">
                <button class="btn btn-secondary" onclick="addOtherHazard()" style="padding: 5px 15px; font-size: 0.85rem;">추가</button>
            `;
            content.appendChild(otherDiv);
            
            modal.style.display = 'block';
        }

        function closeHazardSelector() {
            document.getElementById('hazardSelectorModal').style.display = 'none';
        }

        function applyHazardSelection() {
            const content = document.getElementById('modalContent');
            const checkboxContainer = content.querySelector('div');
            const checkboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]:checked');
            const selectedHazards = Array.from(checkboxes).map(cb => cb.value);
            
            // 현재 공정에 저장
            const process = appData.processes[appData.currentProcessIndex];
            if (!process.hazardClassification) {
                process.hazardClassification = {};
            }
            process.hazardClassification[currentHazardCategory] = selectedHazards;
            
            // 화면 업데이트
            updateHazardDisplay(currentHazardCategory, selectedHazards);
            
            // 모달 닫기
            closeHazardSelector();
        }

        function addOtherHazard() {
            const input = document.getElementById('otherHazardInput');
            const value = input.value.trim();
            
            if (value) {
                // 체크박스 추가
                const content = document.getElementById('modalContent');
                const checkboxContainer = content.querySelector('div');
                
                const label = document.createElement('label');
                label.className = 'modal-checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = value;
                checkbox.checked = true;
                
                const text = document.createElement('span');
                text.textContent = value;
                
                label.appendChild(checkbox);
                label.appendChild(text);
                checkboxContainer.appendChild(label);
                
                // 입력 필드 초기화
                input.value = '';
                
                // 목록에도 추가
                if (!hazardLists[currentHazardCategory].includes(value)) {
                    hazardLists[currentHazardCategory].push(value);
                }
            }
        }

        // ===== 위험성평가표 관련 함수 =====
        let currentAssessmentRow = null;
        
        function loadAssessmentData() {
            // 공정 탭 생성
            const tabContainer = document.getElementById('assessmentProcessTabs');
            tabContainer.innerHTML = '';
            
            appData.processes.forEach((process, index) => {
                const tab = document.createElement('button');
                tab.style.cssText = 'padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s ease; font-weight: 500; color: #4a5568;';
                tab.textContent = process.name || `공정 ${index + 1}`;
                tab.onclick = () => selectAssessmentProcess(index);
                
                if (index === appData.currentProcessIndex) {
                    tab.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    tab.style.color = 'white';
                    tab.style.borderColor = 'transparent';
                }
                
                tabContainer.appendChild(tab);
            });
            
            // 오늘 날짜 설정
            const assessmentDateInput = document.getElementById('assessmentDate');
            if (assessmentDateInput && !assessmentDateInput.value) {
                assessmentDateInput.valueAsDate = new Date();
            }
            
            // 현재 공정 선택
            selectAssessmentProcess(appData.currentProcessIndex);
        }

        function selectAssessmentProcess(index) {
            appData.currentProcessIndex = index;
            const process = appData.processes[index];
            
            // 탭 스타일 업데이트
            const tabs = document.querySelectorAll('#assessmentProcessTabs button');
            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.style.background = 'linear-gradient(135deg, #e6d7c3, #d4c4a8)';
                    tab.style.color = '#2d3748';
                    tab.style.borderColor = 'transparent';
                } else {
                    tab.style.background = 'white';
                    tab.style.color = '#4a5568';
                    tab.style.borderColor = '#e2e8f0';
                }
            });
            
            // 공정명 표시
            document.getElementById('assessmentProcessName').value = process.name || `공정 ${index + 1}`;
            
            // 평가자 자동 입력 (작업공정에서 입력한 평가자명)
            const evaluatorInput = document.getElementById('assessmentEvaluator');
            if (evaluatorInput && !evaluatorInput.value && appData.workplace.evaluator) {
                evaluatorInput.value = appData.workplace.evaluator;
            }
            
            // 기존 평가 데이터 로드 또는 새로 생성
            loadAssessmentTable(process);
        }

        function loadAssessmentTable(process) {
            const tbody = document.getElementById('assessmentTableBody');
            tbody.innerHTML = '';
            
            if (process.assessments && process.assessments.length > 0) {
                // 기존 평가 데이터 로드
                process.assessments.forEach((assessment, index) => {
                    createAssessmentRow(assessment, index + 1);
                });
            } else {
                // 유해위험요인분류에서 선택된 항목들을 기반으로 자동 생성
                if (process.hazardClassification) {
                    let rowNumber = 1;
                    Object.keys(process.hazardClassification).forEach(category => {
                        const hazards = process.hazardClassification[category];
                        hazards.forEach(hazard => {
                            createAssessmentRow({
                                workContent: '',  // 비워둠
                                classification: getCategoryKoreanName(category),
                                hazard: hazard,
                                cause: '',
                                legalBasis: [],
                                currentState: '',
                                possibility: '',
                                severity: '',
                                risk: '',
                                measures: '',
                                improvedRisk: '',
                                improvementDate: '',
                                completionDate: '',
                                manager: '',
                                note: ''
                            }, rowNumber++);
                        });
                    });
                }
                
                // 항목이 없으면 빈 행 하나 추가
                if (tbody.children.length === 0) {
                    addAssessmentRow();
                }
            }
        }

        function getCategoryKoreanName(category) {
            const names = {
                'mechanical': '기계(설비)적 요인',
                'electrical': '전기적 요인',
                'chemical': '화학(물질)적 요인',
                'biological': '생물학적 요인',
                'ergonomic': '작업특성 요인',
                'other': '작업환경 요인'
            };
            return names[category] || category;
        }

        function createAssessmentRow(data = {}, rowNumber = null) {
            const tbody = document.getElementById('assessmentTableBody');
            const row = document.createElement('tr');
            
            if (!rowNumber) {
                rowNumber = tbody.children.length + 1;
            }
            
            row.innerHTML = `
                <td style="padding: 8px; border: 1px solid #e2e8f0; text-align: center; vertical-align: top; min-width: 120px;">
                    <textarea placeholder="작업내용 입력" style="width: 100%; min-height: 80px; resize: vertical; font-size: 0.9rem; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;">${data.workContent || ''}</textarea>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 100px;">
                    <input type="text" value="${data.classification || ''}" readonly style="width: 100%; background: #f7fafc; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem;">
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 150px;">
                    <textarea placeholder="원인을 상세히 입력하세요" style="width: 100%; min-height: 80px; resize: vertical; font-size: 0.9rem; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;">${data.cause || ''}</textarea>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 200px;">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <textarea placeholder="유해 위험 요인을 상세히 입력하세요" readonly style="width: 100%; min-height: 60px; resize: vertical; font-size: 0.9rem; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px; background: #f7fafc;">${data.hazard || ''}</textarea>
                        <div style="display: flex; gap: 3px;">
                            <button class="copy-row-btn" onclick="copyRow(this)" title="이 행 복사" style="flex: 1; padding: 4px; font-size: 0.8rem; background: #4299e1; color: white; border: none; border-radius: 3px; cursor: pointer;">📋 복사</button>
                            <button class="copy-row-btn" onclick="deleteRow(this)" title="이 행 삭제" style="flex: 1; padding: 4px; font-size: 0.8rem; background: #e53e3e; color: white; border: none; border-radius: 3px; cursor: pointer;">🗑️ 삭제</button>
                        </div>
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 180px;">
                    <div class="legal-basis-display" onclick="showLegalBasisModal(this)">
                        ${data.legalBasis && data.legalBasis.length > 0 ? 
                            data.legalBasis.map(item => `<div style="font-size: 0.8rem; margin: 3px 0; padding: 3px 6px; background: white; border-radius: 4px; border-left: 3px solid #667eea; word-break: break-word;">${item}</div>`).join('') : 
                            '<span style="color: #a0aec0; display: flex; align-items: center; justify-content: center; height: 60px; text-align: center;">📋 클릭하여<br>법규 선택</span>'}
                    </div>
                    <input type="hidden" class="legal-basis-data" value='${JSON.stringify(data.legalBasis || [])}'>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 180px;">
                    <textarea placeholder="현재 상태 및 조치사항을 상세히 입력하세요" style="width: 100%; min-height: 80px; resize: vertical; font-size: 0.9rem; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;">${data.currentState || ''}</textarea>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 80px;">
                    <select onchange="calculateRisk(this)" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem; background: white;">
                        <option value="">선택</option>
                        <option value="5" ${data.possibility === '5' ? 'selected' : ''}>매우높음(5)</option>
                        <option value="4" ${data.possibility === '4' ? 'selected' : ''}>높음(4)</option>
                        <option value="3" ${data.possibility === '3' ? 'selected' : ''}>보통(3)</option>
                        <option value="2" ${data.possibility === '2' ? 'selected' : ''}>낮음(2)</option>
                        <option value="1" ${data.possibility === '1' ? 'selected' : ''}>매우낮음(1)</option>
                    </select>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 80px;">
                    <select onchange="calculateRisk(this)" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem; background: white;">
                        <option value="">선택</option>
                        <option value="4" ${data.severity === '4' ? 'selected' : ''}>매우위험(4)</option>
                        <option value="3" ${data.severity === '3' ? 'selected' : ''}>위험(3)</option>
                        <option value="2" ${data.severity === '2' ? 'selected' : ''}>보통(2)</option>
                        <option value="1" ${data.severity === '1' ? 'selected' : ''}>양호(1)</option>
                    </select>
                </td>
                <td class="risk-result" style="padding: 8px; border: 1px solid #e2e8f0; text-align: center; font-weight: 600; vertical-align: top; min-height: 80px; min-width: 80px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                    ${data.risk || '-'}
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 200px;">
                    <textarea placeholder="감소 대책을 상세히 입력하세요" style="width: 100%; min-height: 80px; resize: vertical; font-size: 0.9rem; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;">${data.measures || ''}</textarea>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 100px;">
                    <select class="improved-risk-select" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem; background: white;">
                        <option value="">선택</option>
                        <option value="매우낮음" ${data.improvedRisk === '매우낮음' ? 'selected' : ''}>매우낮음</option>
                        <option value="낮음" ${data.improvedRisk === '낮음' ? 'selected' : ''}>낮음</option>
                        <option value="보통" ${data.improvedRisk === '보통' ? 'selected' : ''}>보통</option>
                        <option value="높음" ${data.improvedRisk === '높음' ? 'selected' : ''}>높음</option>
                    </select>
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 120px;">
                    <input type="date" value="${data.improvementDate || ''}" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem;">
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 120px;">
                    <input type="date" value="${data.completionDate || ''}" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem;">
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 100px;">
                    <input type="text" placeholder="담당자명" value="${data.manager || ''}" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem;">
                </td>
                <td style="padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; min-width: 120px;">
                    <textarea placeholder="비고사항" style="width: 100%; min-height: 80px; resize: vertical; font-size: 0.9rem; padding: 6px; border: 1px solid #cbd5e0; border-radius: 4px;">${data.note || ''}</textarea>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // 위험성이 이미 계산된 경우 색상 적용
            if (data.risk) {
                applyRiskColor(row.querySelector('.risk-result'), data.risk);
            }
        }

        function addAssessmentRow() {
            createAssessmentRow();
        }

        function calculateRisk(element) {
            const row = element.closest('tr');
            const possibility = row.cells[6].querySelector('select').value;
            const severity = row.cells[7].querySelector('select').value;
            const riskCell = row.cells[8];
            
            if (possibility && severity) {
                const risk = parseInt(possibility) * parseInt(severity);
                riskCell.textContent = risk;
                applyRiskColor(riskCell, risk);
            }
        }

        function applyRiskColor(cell, risk) {
            cell.classList.remove('risk-very-high', 'risk-high', 'risk-medium', 'risk-low', 'risk-very-low');
            
            if (risk >= 12) {
                // 높음 (12~20)
                cell.style.background = '#ff8787';
                cell.style.color = 'white';
                cell.style.fontWeight = '600';
            } else if (risk >= 6) {
                // 보통 (6~11)
                cell.style.background = '#ffd43b';
                cell.style.color = '#000';
                cell.style.fontWeight = '600';
            } else if (risk >= 1) {
                // 낮음 (1~5)
                cell.style.background = '#51cf66';
                cell.style.color = '#000';
                cell.style.fontWeight = '600';
            }
        }

        function copyRow(button) {
            const sourceRow = button.closest('tr');
            const tbody = sourceRow.parentElement;
            const rowData = {
                workContent: sourceRow.cells[0].querySelector('input').value,
                classification: sourceRow.cells[1].querySelector('input').value,
                cause: '', // 원인은 비워둠 (새로 입력하도록)
                hazard: sourceRow.cells[3].querySelector('div input').value,
                legalBasis: JSON.parse(sourceRow.querySelector('.legal-basis-data').value || '[]'),
                currentState: '', // 현재상태도 새로 입력
                possibility: '',
                severity: '',
                risk: '',
                measures: '',
                improvedRisk: '',
                improvementDate: '',
                completionDate: '',
                manager: '',
                note: ''
            };
            
            // 새 행 생성
            createAssessmentRow(rowData);
            showNotification('행이 복사되었습니다. 원인을 입력해주세요.', 'success');
        }

        function deleteRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentElement;
            
            // 최소 1개 행은 남겨두기
            if (tbody.children.length > 1) {
                if (confirm('이 행을 삭제하시겠습니까?')) {
                    row.remove();
                    showNotification('행이 삭제되었습니다.', 'success');
                }
            } else {
                showNotification('최소 1개의 행은 유지되어야 합니다.', 'error');
            }
        }

        function showLegalBasisModal(element) {
            console.log('showLegalBasisModal 호출됨', element);
            
            try {
                currentAssessmentRow = element.closest('tr');
                const modal = document.getElementById('legalBasisModal');
                
                if (!modal) {
                    console.error('legalBasisModal을 찾을 수 없습니다.');
                    showNotification('법적 근거 모달을 찾을 수 없습니다. 페이지를 새로고침해주세요.', 'error');
                    return;
                }
                
                // 법규 데이터가 로드되었는지 확인
                if (!legalBasisData || legalBasisData.length === 0) {
                    console.warn('법규 데이터가 로드되지 않았습니다. 기본 데이터를 로드합니다.');
                    loadDefaultLegalBasis();
                }
            
            // 현재 선택된 법규 가져오기
            const currentData = currentAssessmentRow.querySelector('.legal-basis-data').value;
            const selectedItems = JSON.parse(currentData || '[]');
            
            // 현재 행의 유해위험요인 가져오기 (추천용)
            const hazardText = currentAssessmentRow.cells[3].querySelector('textarea').value;
            
            // 관련 법규 찾기
            let recommendedLaws = [];
            if (hazardText) {
                // 유해위험요인 텍스트에서 매칭되는 키워드 찾기
                Object.keys(legalBasisMapping).forEach(key => {
                    if (hazardText.includes(key) || key.includes(hazardText)) {
                        recommendedLaws.push(...legalBasisMapping[key]);
                    }
                });
                
                // 중복 제거
                recommendedLaws = [...new Set(recommendedLaws)];
            }
            
            const content = document.getElementById('legalBasisContent');
            
            // 드롭다운 선택 방식으로 변경
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px;">유해위험요인: ${hazardText || '미지정'}</label>
                </div>
                
                ${recommendedLaws.length > 0 ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: #e6fffa; border-radius: 8px; border: 1px solid #38b2ac;">
                        <h4 style="margin: 0 0 15px 0; color: #234e52;">📋 추천 법규 (${hazardText})</h4>
                        <div style="display: grid; gap: 10px;">
                            ${recommendedLaws.map(law => `
                                <label class="modal-checkbox-label" style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #38b2ac;">
                                    <input type="checkbox" value="${law}" ${selectedItems.includes(law) ? 'checked' : ''}>
                                    <span style="color: #2c5282; font-weight: 500; font-size: 0.95rem;">${law}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 8px; color: #718096; font-size: 0.9rem;">
                    💡 추천 법규 ${recommendedLaws.length}개가 표시됩니다.
                </div>
            `;
            
            modal.style.display = 'block';
            
            } catch (error) {
                console.error('법적 근거 모달 표시 중 오류:', error);
                showNotification('법적 근거 모달을 표시하는 중 오류가 발생했습니다.', 'error');
            }
        }

        // 법규명 정리 함수 (괄호 안 설명 제거)
        function cleanLegalBasisName(lawName) {
            // 괄호로 시작하는 부분 제거 (예: "산업안전보건기준에 관한 규칙 제103조(프레스 등의 위험 방지)" -> "산업안전보건기준에 관한 규칙 제103조")
            return lawName.replace(/\s*\([^)]*\)/g, '').trim();
        }

        // 법규 검색 필터 함수
        function filterLegalBasis() {
            const searchValue = document.getElementById('legalSearchInput').value.toLowerCase();
            const labels = document.querySelectorAll('.modal-checkbox-label');
            let visibleCount = 0;
            
            labels.forEach(label => {
                const text = label.getAttribute('data-law-text');
                if (text && text.includes(searchValue)) {
                    label.style.display = 'flex';
                    visibleCount++;
                } else {
                    label.style.display = 'none';
                }
            });
            
            // 검색 결과가 없을 때 메시지 표시
            const listContainer = document.getElementById('legalBasisList');
            let noResultsMsg = listContainer.querySelector('.no-results-msg');
            
            if (visibleCount === 0 && searchValue) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-results-msg';
                    noResultsMsg.style.cssText = 'text-align: center; color: #718096; padding: 20px; font-style: italic;';
                    noResultsMsg.textContent = `"${searchValue}"에 대한 검색 결과가 없습니다.`;
                    listContainer.appendChild(noResultsMsg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }

        function closeLegalBasisModal() {
            document.getElementById('legalBasisModal').style.display = 'none';
        }

        function applyLegalBasis() {
            if (!currentAssessmentRow) return;
            
            const content = document.getElementById('legalBasisContent');
            const checkboxes = content.querySelectorAll('input[type="checkbox"]:checked');
            const selectedBasis = Array.from(checkboxes).map(cb => cb.value);
            
            // 선택된 법적 근거 저장 및 표시
            const legalBasisDisplay = currentAssessmentRow.querySelector('.legal-basis-display');
            const legalBasisData = currentAssessmentRow.querySelector('.legal-basis-data');
            
            legalBasisData.value = JSON.stringify(selectedBasis);
            
            if (selectedBasis.length > 0) {
                legalBasisDisplay.innerHTML = selectedBasis.map(item => 
                    `<div style="font-size: 0.8rem; margin: 3px 0; padding: 3px 6px; background: white; border-radius: 4px; border-left: 3px solid #667eea; word-break: break-word;">${item}</div>`
                ).join('');
            } else {
                legalBasisDisplay.innerHTML = '<span style="color: #a0aec0; display: flex; align-items: center; justify-content: center; height: 60px; text-align: center;">📋 클릭하여<br>법규 선택</span>';
            }
            
            closeLegalBasisModal();
        }

        // 전체 선택 기능
        function selectAllLegalBasis() {
            const content = document.getElementById('legalBasisContent');
            const checkboxes = content.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            showNotification('모든 법규가 선택되었습니다.', 'success');
        }

        // 전체 해제 기능
        function deselectAllLegalBasis() {
            const content = document.getElementById('legalBasisContent');
            const checkboxes = content.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            showNotification('모든 법규가 해제되었습니다.', 'success');
        }

        // ===== 위험감소대책 관련 함수 =====
        function loadReductionData() {
            // 오늘 날짜 설정
            const reductionDateInput = document.getElementById('reductionDate');
            if (reductionDateInput && !reductionDateInput.value) {
                reductionDateInput.valueAsDate = new Date();
            }
            
            // 테이블에 기본 행이 없으면 하나 추가
            const tbody = document.getElementById('reductionTableBody');
            if (tbody && tbody.children.length === 0) {
                addReductionRow();
            }
        }

        function addReductionRow() {
            const tbody = document.getElementById('reductionTableBody');
            const rowNumber = tbody.children.length + 1;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                    <input type="text" value="${rowNumber}" readonly style="text-align: center; width: 100%; background: #f7fafc;">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <input type="text" placeholder="재해 형태 입력">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <textarea placeholder="감소대책을 구체적으로 작성" rows="3" style="width: 100%;"></textarea>
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <input type="text" placeholder="조치결과">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <input type="date">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <input type="date">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <input type="text" placeholder="비용/진원">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                    <button class="delete-btn" onclick="this.parentElement.parentElement.remove()">삭제</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        // ===== 개선활동 관련 함수 =====
        function loadImprovementData() {
            // 오늘 날짜 설정
            const improvementDateInput = document.getElementById('improvementWriteDate');
            if (improvementDateInput && !improvementDateInput.value) {
                improvementDateInput.valueAsDate = new Date();
            }
            
            // 테이블에 기본 행이 없으면 하나 추가
            const tbody = document.getElementById('improvementTableBody');
            if (tbody && tbody.children.length === 0) {
                addImprovementRow();
            }
        }

        function addImprovementRow() {
            const tbody = document.getElementById('improvementTableBody');
            const rowNumber = tbody.children.length + 1;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                    <input type="text" value="${rowNumber}" readonly style="text-align: center; width: 100%; background: #f7fafc;">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <input type="text" placeholder="위험성평가 내용">
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <textarea placeholder="감소대책" rows="2" style="width: 100%;"></textarea>
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <select onchange="calculateImprovementRisk(this)" style="width: 100%;">
                        <option value="">선택</option>
                        <option value="5">매우자주(5)</option>
                        <option value="4">자주(4)</option>
                        <option value="3">보통(3)</option>
                        <option value="2">가끔(2)</option>
                        <option value="1">매우가끔(1)</option>
                    </select>
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0;">
                    <select onchange="calculateImprovementRisk(this)" style="width: 100%;">
                        <option value="">선택</option>
                        <option value="4">매우위험(4)</option>
                        <option value="3">위험(3)</option>
                        <option value="2">보통(2)</option>
                        <option value="1">양호(1)</option>
                    </select>
                </td>
                <td class="improvement-risk-result" style="padding: 10px; border: 1px solid #e2e8f0; text-align: center; font-weight: 600;">
                    -
                </td>
                <td style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">
                    <button class="delete-btn" onclick="this.parentElement.parentElement.remove()">삭제</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        function calculateImprovementRisk(element) {
            const row = element.closest('tr');
            const possibility = row.cells[3].querySelector('select').value;
            const severity = row.cells[4].querySelector('select').value;
            const riskCell = row.cells[5];
            
            if (possibility && severity) {
                const risk = parseInt(possibility) * parseInt(severity);
                riskCell.textContent = risk;
                applyRiskColor(riskCell, risk);
            }
        }

        // PDF 리포트 생성
        function generatePDFReport() {
            try {
                console.log('PDF 리포트 생성 시작...');
                
                // jsPDF 라이브러리 확인
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF 라이브러리가 로드되지 않았습니다.');
                }
                
                // jsPDF 객체 생성 (가로 방향)
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');
                
                console.log('jsPDF 객체 생성 완료');
                
                // 기본 폰트 설정
                doc.setFont('helvetica');
                
                // 데이터 수집
                const reportData = collectReportData();
                console.log('리포트 데이터 수집 완료:', reportData);
                
                // 간단한 PDF 생성
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                
                // 제목 페이지
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('Risk Assessment Report', pageWidth / 2, 60, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text(`Date: ${new Date().toLocaleDateString('ko-KR')}`, pageWidth / 2, 80, { align: 'center' });
                doc.text(`Author: ${reportData.workplace?.ceo || 'Not specified'}`, pageWidth / 2, 95, { align: 'center' });
                
                // 다음 페이지로
                doc.addPage();
                
                // 사업장 정보
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('1. Workplace Information', margin, 30);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const workplaceInfo = [
                    ['Company Name', reportData.company?.name || ''],
                    ['Address', reportData.company?.address || ''],
                    ['CEO', reportData.workplace?.ceo || ''],
                    ['Industry', reportData.workplace?.products || ''],
                    ['Main Products', reportData.workplace?.products || '']
                ];
                
                doc.autoTable({
                    startY: 45,
                    head: [['Item', 'Content']],
                    body: workplaceInfo,
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [230, 215, 195] }
                });
                
                // PDF 저장
                const fileName = `위험성평가_리포트_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF 리포트가 생성되었습니다!', 'success');
                console.log('PDF 리포트 생성 완료');
                
            } catch (error) {
                console.error('PDF 리포트 생성 중 오류:', error);
                showNotification(`PDF 생성 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // PDF 페이지 생성
        function createPDFPages(doc, data) {
            let currentY = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            
            // 제목 페이지
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            addSimpleText(doc, '위험성평가 보고서', pageWidth / 2, 60, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            addSimpleText(doc, `작성일: ${new Date().toLocaleDateString('ko-KR')}`, pageWidth / 2, 80, { align: 'center' });
            addSimpleText(doc, `작성자: ${data.workplace?.ceo || '미지정'}`, pageWidth / 2, 95, { align: 'center' });
            
            // 다음 페이지로
            doc.addPage();
            currentY = 20;
            
            // 사업장 정보
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            addSimpleText(doc, '1. 사업장 정보', margin, currentY);
            currentY += 15;
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            const workplaceInfo = [
                ['사업장명', data.company?.name || ''],
                ['주소', data.company?.address || ''],
                ['대표자', data.workplace?.ceo || ''],
                ['업종', data.workplace?.products || ''],
                ['주요생산품', data.workplace?.products || '']
            ];
            
            doc.autoTable({
                startY: currentY,
                head: [['구분', '내용']],
                body: workplaceInfo,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [230, 215, 195] }
            });
            
            currentY = doc.lastAutoTable.finalY + 15;
            
            // 공정 정보
            if (data.processes && data.processes.length > 0) {
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                addSimpleText(doc, '2. 공정 정보', margin, currentY);
                currentY += 15;
                
                const processData = data.processes.map((process, index) => [
                    index + 1,
                    process.name || '',
                    process.description || '',
                    process.equipment?.length || 0
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['번호', '공정명', '공정내용', '설비수']],
                    body: processData,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [230, 215, 195] }
                });
                
                currentY = doc.lastAutoTable.finalY + 15;
            }
            
            // 위험성평가표 (각 공정별로 별도 페이지)
            if (data.processes && data.processes.length > 0) {
                data.processes.forEach((process, processIndex) => {
                    if (process.assessments && process.assessments.length > 0) {
                        // 새 페이지 시작
                        if (processIndex > 0) {
                            doc.addPage();
                            currentY = 20;
                        }
                        
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        addSimpleText(doc, `3-${processIndex + 1}. ${process.name || `공정 ${processIndex + 1}`} 위험성평가표`, margin, currentY);
                        currentY += 15;
                        
                        const assessmentData = process.assessments.map(assessment => [
                            assessment.workContent || '',
                            assessment.classification || '',
                            assessment.cause || '',
                            assessment.hazard || '',
                            assessment.currentState || '',
                            assessment.possibility || '',
                            assessment.severity || '',
                            assessment.risk || '',
                            assessment.measures || ''
                        ]);
                        
                        doc.autoTable({
                            startY: currentY,
                            head: [['작업내용', '분류', '원인', '유해위험요인', '현재상태', '가능성', '중대성', '위험성', '감소대책']],
                            body: assessmentData,
                            theme: 'grid',
                            styles: { fontSize: 7, cellPadding: 2 },
                            headStyles: { fillColor: [230, 215, 195], fontSize: 8 },
                            columnStyles: {
                                0: { cellWidth: 25 },
                                1: { cellWidth: 15 },
                                2: { cellWidth: 20 },
                                3: { cellWidth: 25 },
                                4: { cellWidth: 25 },
                                5: { cellWidth: 12 },
                                6: { cellWidth: 12 },
                                7: { cellWidth: 12 },
                                8: { cellWidth: 30 }
                            }
                        });
                        
                        currentY = doc.lastAutoTable.finalY + 15;
                    }
                });
            }
            
            // 위험감소대책
            doc.addPage();
            currentY = 20;
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            addSimpleText(doc, '4. 위험감소대책 및 실행계획서', margin, currentY);
            currentY += 15;
            
            const reductionTable = document.getElementById('reductionTableBody');
            if (reductionTable) {
                const rows = reductionTable.querySelectorAll('tr');
                const reductionData = [];
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        reductionData.push([
                            getElementValueFromCell(cells[1], 'input') || '',
                            getElementValueFromCell(cells[2], 'textarea') || '',
                            getElementValueFromCell(cells[3], 'input') || '',
                            getElementValueFromCell(cells[4], 'input') || '',
                            getElementValueFromCell(cells[5], 'input') || ''
                        ]);
                    }
                });
                
                if (reductionData.length > 0) {
                    doc.autoTable({
                        startY: currentY,
                        head: [['재해형태', '감소대책', '조치결과', '일정', '확인일자']],
                        body: reductionData,
                        theme: 'grid',
                        styles: { fontSize: 9 },
                        headStyles: { fillColor: [230, 215, 195] }
                    });
                }
            }
        }

        // 엑셀 리포트 생성 함수
        async function generateExcelReport() {
            try {
                showNotification('엑셀 리포트 생성 중...', 'success');
                
                // 1. 새 워크북 생성 (템플릿 로드 시도하지 않음)
                const workbook = XLSX.utils.book_new();
                
                // 2. 데이터 수집
                const reportData = collectReportData();
                console.log('수집된 데이터:', reportData);
                
                // 3. 워크시트 생성
                const worksheets = createReportWorksheets(reportData);
                console.log('생성된 워크시트 수:', worksheets.length);
                
                // 4. 워크북에 워크시트 추가
                const sheetNames = [
                    '표지',
                    '작업공정',
                    '위험정보',
                    '유해위험요인분류',
                    '위험성평가표',
                    '위험감소대책',
                    '개선활동'
                ];
                
                worksheets.forEach((worksheet, index) => {
                    const sheetName = sheetNames[index] || `시트${index + 1}`;
                    try {
                        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                        console.log(`시트 추가 완료: ${sheetName}`);
                    } catch (sheetError) {
                        console.error(`시트 추가 실패 (${sheetName}):`, sheetError);
                    }
                });
                
                // 5. 파일 다운로드
                const fileName = `위험성평가_결과서_${new Date().toISOString().split('T')[0]}.xlsx`;
                console.log('파일명:', fileName);
                
                XLSX.writeFile(workbook, fileName);
                
                showNotification('엑셀 리포트가 성공적으로 생성되었습니다!', 'success');
                
            } catch (error) {
                console.error('엑셀 리포트 생성 오류:', error);
                showNotification(`엑셀 리포트 생성 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 리포트 데이터 수집
        function collectReportData() {
            try {
                const data = {
                    // 기본 정보
                    company: {
                        name: getElementValue('companyName') || '',
                        address: getElementValue('companyAddress') || '',
                        tel: getElementValue('companyTel') || '',
                        fax: getElementValue('companyFax') || ''
                    },
                    workplace: {
                        ceo: getElementValue('ceoName') || '',
                        products: getElementValue('mainProducts') || '',
                        employees: getElementValue('employeeCount') || '',
                        evalDate: getElementValue('evalDate') || '',
                        evaluator: getElementValue('evaluatorName') || ''
                    },
                    // 공정 정보
                    processes: (appData.processes || []).map(process => ({
                        name: process.name || '',
                        description: process.description || '',
                        equipment: Array.isArray(process.equipment) ? process.equipment : [],
                        chemicals: Array.isArray(process.chemicals) ? process.chemicals : [],
                        riskInfo: process.riskInfo || {},
                        hazardClassification: process.hazardClassification || {},
                        assessments: Array.isArray(process.assessments) ? process.assessments : []
                    })),
                    // 개선활동 정보
                    improvement: {
                        hazards: getElementValue('improvementHazards') || '',
                        currentPossibility: getElementValue('currentPossibility') || '',
                        currentSeverity: getElementValue('currentSeverity') || '',
                        currentRisk: getElementValue('currentRisk') || '',
                        improvedPossibility: getElementValue('improvedPossibility') || '',
                        improvedSeverity: getElementValue('improvedSeverity') || '',
                        improvedRisk: getElementValue('improvedRisk') || '',
                        details: getElementValue('improvementDetails') || ''
                    }
                };
                
                console.log('데이터 수집 완료:', data);
                return data;
                
            } catch (error) {
                console.error('데이터 수집 중 오류:', error);
                return {
                    company: { name: '', address: '', tel: '', fax: '' },
                    workplace: { ceo: '', products: '', employees: '', evalDate: '', evaluator: '' },
                    processes: [],
                    improvement: { hazards: '', currentPossibility: '', currentSeverity: '', currentRisk: '', improvedPossibility: '', improvedSeverity: '', improvedRisk: '', details: '' }
                };
            }
        }

        // 안전한 요소 값 가져오기 함수
        function getElementValue(elementId) {
            try {
                const element = document.getElementById(elementId);
                if (!element) return '';
                
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    return element.value || '';
                } else if (element.tagName === 'SELECT') {
                    return element.value || '';
                } else {
                    return element.textContent || '';
                }
            } catch (error) {
                console.error(`요소 값 가져오기 실패 (${elementId}):`, error);
                return '';
            }
        }

        // 리포트 워크시트 생성
        function createReportWorksheets(data) {
            const worksheets = [];
            
            // 1. 표지 시트
            const coverSheet = createCoverSheet(data);
            worksheets.push(coverSheet);
            
            // 2. 작업공정 시트
            const processSheet = createProcessSheet(data);
            worksheets.push(processSheet);
            
            // 3. 위험정보 시트
            const riskInfoSheet = createRiskInfoSheet(data);
            worksheets.push(riskInfoSheet);
            
            // 4. 유해위험요인분류 시트
            const classificationSheet = createClassificationSheet(data);
            worksheets.push(classificationSheet);
            
            // 5. 위험성평가표 시트
            const assessmentSheet = createAssessmentSheet(data);
            worksheets.push(assessmentSheet);
            
            // 6. 위험감소대책 시트
            const reductionSheet = createReductionSheet(data);
            worksheets.push(reductionSheet);
            
            // 7. 개선활동 시트
            const improvementSheet = createImprovementSheet(data);
            worksheets.push(improvementSheet);
            
            return worksheets;
        }

        // 표지 시트 생성
        function createCoverSheet(data) {
            try {
                const wsData = [
                    ['위험성평가 결과서'],
                    [''],
                    ['사업장 정보'],
                    ['회사명', data.company?.name || ''],
                    ['주소', data.company?.address || ''],
                    ['전화번호', data.company?.tel || ''],
                    ['팩스번호', data.company?.fax || ''],
                    [''],
                    ['평가 정보'],
                    ['대표자', data.workplace?.ceo || ''],
                    ['주요생산품', data.workplace?.products || ''],
                    ['근로자수', (data.workplace?.employees || '') + '명'],
                    ['평가일자', data.workplace?.evalDate || ''],
                    ['평가자', data.workplace?.evaluator || '']
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 열 너비 설정
                ws['!cols'] = [{ width: 15 }, { width: 30 }];
                
                return ws;
            } catch (error) {
                console.error('표지 시트 생성 오류:', error);
                return XLSX.utils.aoa_to_sheet([['오류 발생']]);
            }
        }

        // 작업공정 시트 생성
        function createProcessSheet(data) {
            try {
                const wsData = [
                    ['작업공정 분석'],
                    [''],
                    ['공정명', '공정설명', '주요기계기구', '유해위험물질']
                ];
                
                if (data.processes && Array.isArray(data.processes)) {
                    data.processes.forEach(process => {
                        wsData.push([
                            process.name || '',
                            process.description || '',
                            Array.isArray(process.equipment) ? process.equipment.join(', ') : '',
                            Array.isArray(process.chemicals) ? process.chemicals.join(', ') : ''
                        ]);
                    });
                }
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 열 너비 설정
                ws['!cols'] = [
                    { width: 15 },
                    { width: 25 },
                    { width: 20 },
                    { width: 20 }
                ];
                
                return ws;
            } catch (error) {
                console.error('작업공정 시트 생성 오류:', error);
                return XLSX.utils.aoa_to_sheet([['오류 발생']]);
            }
        }

        // 위험정보 시트 생성
        function createRiskInfoSheet(data) {
            try {
                const wsData = [
                    ['위험정보'],
                    [''],
                    ['공정명', '원재료', '기계기구', '화학물질']
                ];
                
                if (data.processes && Array.isArray(data.processes)) {
                    data.processes.forEach(process => {
                        const riskInfo = process.riskInfo || {};
                        wsData.push([
                            process.name || '',
                            Array.isArray(riskInfo.materials) ? riskInfo.materials.join(', ') : '',
                            Array.isArray(riskInfo.equipment) ? riskInfo.equipment.join(', ') : '',
                            Array.isArray(riskInfo.chemicals) ? riskInfo.chemicals.join(', ') : ''
                        ]);
                    });
                }
                
                return XLSX.utils.aoa_to_sheet(wsData);
            } catch (error) {
                console.error('위험정보 시트 생성 오류:', error);
                return XLSX.utils.aoa_to_sheet([['오류 발생']]);
            }
        }

        // 유해위험요인분류 시트 생성
        function createClassificationSheet(data) {
            try {
                const wsData = [
                    ['유해위험요인분류'],
                    [''],
                    ['공정명', '분류', '유해위험요인']
                ];
                
                if (data.processes && Array.isArray(data.processes)) {
                    data.processes.forEach(process => {
                        const classification = process.hazardClassification || {};
                        Object.keys(classification).forEach(category => {
                            const hazards = classification[category];
                            if (Array.isArray(hazards)) {
                                hazards.forEach(hazard => {
                                    wsData.push([
                                        process.name || '',
                                        getCategoryKoreanName(category),
                                        hazard || ''
                                    ]);
                                });
                            }
                        });
                    });
                }
                
                return XLSX.utils.aoa_to_sheet(wsData);
            } catch (error) {
                console.error('유해위험요인분류 시트 생성 오류:', error);
                return XLSX.utils.aoa_to_sheet([['오류 발생']]);
            }
        }

        // 위험성평가표 시트 생성
        function createAssessmentSheet(data) {
            try {
                const wsData = [
                    ['위험성평가표'],
                    [''],
                    ['공정명', '작업내용', '분류', '원인', '유해위험요인', '현재상태및조치', '가능성', '중대성', '위험성', '감소대책', '개선후위험성', '개선예정일', '완료일', '담당자', '비고']
                ];
                
                if (data.processes && Array.isArray(data.processes)) {
                    data.processes.forEach(process => {
                        const assessments = process.assessments || [];
                        if (Array.isArray(assessments)) {
                            assessments.forEach(assessment => {
                                wsData.push([
                                    process.name || '',
                                    assessment.workContent || '',
                                    assessment.classification || '',
                                    assessment.cause || '',
                                    assessment.hazard || '',
                                    assessment.currentState || '',
                                    assessment.possibility || '',
                                    assessment.severity || '',
                                    assessment.risk || '',
                                    assessment.measures || '',
                                    assessment.improvedRisk || '',
                                    assessment.improvementDate || '',
                                    assessment.completionDate || '',
                                    assessment.manager || '',
                                    assessment.note || ''
                                ]);
                            });
                        }
                    });
                }
                
                return XLSX.utils.aoa_to_sheet(wsData);
            } catch (error) {
                console.error('위험성평가표 시트 생성 오류:', error);
                return XLSX.utils.aoa_to_sheet([['오류 발생']]);
            }
        }

        // 위험감소대책 시트 생성
        function createReductionSheet(data) {
            try {
                const wsData = [
                    ['위험감소대책 및 실행계획서'],
                    [''],
                    ['공정명', '재해형태', '감소대책', '조치결과', '일정', '확인일자', '비고']
                ];
                
                // 위험감소대책 테이블에서 데이터 수집
                const reductionTable = document.getElementById('reductionTableBody');
                if (reductionTable) {
                    const rows = reductionTable.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 7) {
                            const rowData = [
                                data.workplace?.products || '', // 공정명 (주요생산품으로 대체)
                                getElementValueFromCell(cells[1], 'input') || '', // 재해형태
                                getElementValueFromCell(cells[2], 'textarea') || '', // 감소대책
                                getElementValueFromCell(cells[3], 'input') || '', // 조치결과
                                getElementValueFromCell(cells[4], 'input') || '', // 일정
                                getElementValueFromCell(cells[5], 'input') || '', // 확인일자
                                getElementValueFromCell(cells[6], 'input') || ''  // 비고
                            ];
                            wsData.push(rowData);
                        }
                    });
                }
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 열 너비 설정
                ws['!cols'] = [
                    { width: 15 },
                    { width: 15 },
                    { width: 30 },
                    { width: 15 },
                    { width: 12 },
                    { width: 12 },
                    { width: 15 }
                ];
                
                return ws;
            } catch (error) {
                console.error('위험감소대책 시트 생성 오류:', error);
                return XLSX.utils.aoa_to_sheet([['오류 발생']]);
            }
        }

        // 개선활동 시트 생성
        function createImprovementSheet(data) {
            try {
                const wsData = [
                    ['위험성평가 개선 안전보건활동 내용'],
                    [''],
                    ['유해위험요인', data.improvement?.hazards || ''],
                    [''],
                    ['현재 위험성'],
                    ['가능성', '중대성', '위험성'],
                    [data.improvement?.currentPossibility || '', data.improvement?.currentSeverity || '', data.improvement?.currentRisk || ''],
                    [''],
                    ['개선 후 위험성'],
                    ['가능성', '중대성', '위험성'],
                    [data.improvement?.improvedPossibility || '', data.improvement?.improvedSeverity || '', data.improvement?.improvedRisk || ''],
                    [''],
                    ['개선사항'],
                    [data.improvement?.details || ''],
                    [''],
                    ['개선활동 상세 내역'],
                    ['순번', '위험성평가', '감소대책', '개선후가능성', '개선후중대성', '개선후위험성']
                ];
                
                // 개선활동 테이블에서 데이터 수집
                const improvementTable = document.getElementById('improvementTableBody');
                if (improvementTable) {
                    const rows = improvementTable.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            const rowData = [
                                index + 1,
                                getElementValueFromCell(cells[1], 'input') || '', // 위험성평가
                                getElementValueFromCell(cells[2], 'textarea') || '', // 감소대책
                                getElementValueFromCell(cells[3], 'select') || '', // 개선후가능성
                                getElementValueFromCell(cells[4], 'select') || '', // 개선후중대성
                                cells[5]?.textContent || '' // 개선후위험성
                            ];
                            wsData.push(rowData);
                        }
                    });
                }
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 열 너비 설정
                ws['!cols'] = [
                    { width: 8 },
                    { width: 25 },
                    { width: 30 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 }
                ];
                
                return ws;
            } catch (error) {
                console.error('개선활동 시트 생성 오류:', error);
                return XLSX.utils.aoa_to_sheet([['오류 발생']]);
            }
        }

        // 셀에서 요소 값 가져오기 함수
        function getElementValueFromCell(cell, elementType) {
            try {
                if (!cell) return '';
                const element = cell.querySelector(elementType);
                if (!element) return '';
                
                if (elementType === 'select') {
                    return element.value || '';
                } else {
                    return element.value || '';
                }
            } catch (error) {
                return '';
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료');
            
            // 연도 설정
            const yearElement = document.getElementById('reportYear');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }
            
            // 엑셀에서 법규 데이터 로드
            loadLegalBasisFromExcel();
            
            // ==========================================================
            // ===== 탭 네비게이션 오류 수정 (핵심 수정 부분) =====
            // ==========================================================
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.addEventListener('click', function(event) {
                    event.preventDefault(); // 기본 동작 방지
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });

            // 이전 버튼 이벤트 리스너 추가
            const prevButtons = document.querySelectorAll('[data-prev-tab]');
            prevButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetTab = this.getAttribute('data-prev-tab');
                    showTab(targetTab);
                });
            });
            
            // 저장하고 다음 버튼 이벤트 리스너 추가
            const saveButtons = document.querySelectorAll('[data-save-tab]');
            saveButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetTab = this.getAttribute('data-save-tab');
                    saveAndNext(targetTab);
                });
            });
            
            // 평가 항목 추가 버튼 이벤트 리스너
            document.querySelectorAll('[data-add-assessment]').forEach(btn => {
                btn.addEventListener('click', function() {
                    addAssessmentRow();
                });
            });
            
            // 대책 추가 버튼 이벤트 리스너
            document.querySelectorAll('[data-add-reduction]').forEach(btn => {
                btn.addEventListener('click', function() {
                    addReductionRow();
                });
            });
            
            // 엑셀 리포트 생성 버튼 이벤트 리스너
            document.querySelectorAll('[data-generate-excel]').forEach(btn => {
                btn.addEventListener('click', function() {
                    generateExcelReport();
                });
            });
            
            // PDF 리포트 생성 버튼 이벤트 리스너
            document.querySelectorAll('[data-generate-pdf]').forEach(btn => {
                btn.addEventListener('click', function() {
                    generatePDFReport();
                });
            });
            
            // 개선활동 탭 위험성 계산 이벤트 리스너
            const currentPossibility = document.getElementById('currentPossibility');
            const currentSeverity = document.getElementById('currentSeverity');
            
            if (currentPossibility && currentSeverity) {
                currentPossibility.addEventListener('change', calculateCurrentRisk);
                currentSeverity.addEventListener('change', calculateCurrentRisk);
            }
            
            const improvedPossibility = document.getElementById('improvedPossibility');
            const improvedSeverity = document.getElementById('improvedSeverity');
            
            if (improvedPossibility && improvedSeverity) {
                improvedPossibility.addEventListener('change', calculateImprovedRisk);
                improvedSeverity.addEventListener('change', calculateImprovedRisk);
            }
            
        });
    </script>
</body>
</html>